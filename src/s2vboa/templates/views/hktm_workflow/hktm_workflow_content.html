<div class="row">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#hktm-workflow-list-hktm">HKTM workflow status <span class="fa fa-angle-double-down"></span></a>
      </h3>
    </div>
    <!-- /.panel-heading -->
    <div class="panel-body panel-collapse collapse in" id="hktm-workflow-list-hktm">
      {% if orbpre_events_limit|length > 0 %}
      <p>
        <b>The following table shows the status of the HKTM dissemination to FOS for all the covered orbits</b>:
      </p>
      <a data-toggle="collapse" data-parent="#accordion" href="#hktm-workflow-columns-help-list-hktm"><b>Columns help:</b> <span class="fa fa-angle-double-down"></span></a>
      <div class="panel-body panel-collapse collapse" id="hktm-workflow-columns-help-list-hktm">
        {% include "views/hktm_workflow/hktm_workflow_columns_help.html" %}
      </div>
      <!--table-->
      <table width="100%" class="table table-striped table-bordered table-hover table-search" id="hktm-workflow-list-hktm-table">
        <thead>
          <tr>
            <th>Satellite</th>
            <th>Orbit</th>
            <th>Station</th>
            <th>ANX time</th>
            <th>Status</th>
            <th>Completeness status</th>
            <th>HKTM product</th>
            <th>PDMC-FOS time</th>
            <th>Time delivery to FOS (min.)</th>            
            <th>Comments</th>
          </tr>
        </thead>
        <tbody>
          {% for orbpre_event in orbpre_events_limit|sort(attribute="start", reverse=True) %}
          {% set satellite = orbpre_event.eventTexts|selectattr("name", "equalto", "satellite")|map(attribute='value')|first|string %}          
          {% set orbit = orbpre_event.eventDoubles|selectattr("name", "equalto", "orbit")|map(attribute='value')|first|int %}
          {% set orbpre_intersection_playbacks = [orbpre_event]|convert_eboa_events_to_date_segments|intersect_timelines(hktm_workflow_events["playback"]|filter_events_by_text_value("satellite", satellite)|convert_eboa_events_to_date_segments)|list %}

          {% if orbpre_intersection_playbacks|length > 0 %}
          {% for orbpre_intersection_playback in orbpre_intersection_playbacks %}
          {% set event = hktm_workflow_events["playback"]|selectattr("event_uuid", "==", orbpre_intersection_playback["id2"])|first %}

          {% set orbit = event.eventDoubles|selectattr("name", "equalto", "start_orbit")|map(attribute='value')|first|int %}

          <!-- Obtain station -->
          {% set station = "N/A" %}
          {% set station_schedule_uuid = event.eventLinks|selectattr("name", "in", ["STATION_SCHEDULE", "SLOT_REQUEST_EDRS"])|map(attribute='event_uuid_link')|first %}
          {% if station_schedule_uuid %}
          {% set station_schedule = hktm_workflow_events["station_schedule"]|selectattr("event_uuid", "equalto", station_schedule_uuid)|first %}
          {% set station = station_schedule.eventTexts|selectattr("name", "equalto", "station")|map(attribute='value')|first|string %}
          {% endif %}

          {% set status = [] %}
          {% set status_class = [] %}
          {% include "views/hktm_workflow/hktm_workflow_status.html" %}

          {% set completeness_status = [] %}
          {% set completeness_status_class = [] %}          
          {% include "views/hktm_workflow/hktm_workflow_completeness_status.html" %}

          {% include "views/hktm_workflow/hktm_workflow_content_table.html" %}
          {% endfor %}

          {% else %}
          <tr>
            <td>{{ satellite }}</td>
            <td>{{ orbit }}</td>
            {% if station %}
            <td>{{ station }}</td>
            {% else %}
            <td>N/A</td>
            {% endif %}
            <td>{{ orbpre_event["start"].isoformat() }}</td>
            <td class="bold-orange">HKTM PLAYBACK NOT PLANNED</td>
            <td class="bold-orange">HKTM PLAYBACK NOT PLANNED</td>
            <td>N/A</td>
            <td>N/A</td>
            <td>N/A</td>
            <td>{{ comments }}</td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th>Satellite</th>
            <th>Orbit</th>
            <th>Station</th>
            <th>ANX time</th>
            <th>Status</th>
            <th>Completeness status</th>
            <th>HKTM Product</th>
            <th>PDMC-FOS time</th>
            <th>Time delivery to FOS (min.)</th>            
            <th>Comments</th>
          </tr>
        </tfoot>
      </table>
      {% else %}
      <div>
        <p id="hktm-workflow-no-expected-hktm" style="text-indent: 1em"> There are no expected downlinks of HKTM.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
