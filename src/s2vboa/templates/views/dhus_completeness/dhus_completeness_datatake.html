{% extends "panel/index.html" %}

<!-- Expected acquired MSI duration from planning -->
{% set expected_acquisition_duration = ((info["imaging"]|get_timeline_duration) / 60)|round(3) %}

<!-- Expected acquired MSI duration from ISP completeness events -->
{% set expected_acquisition_duration_from_isp_completeness = ((info["isp_completeness"]|get_timeline_duration) / 60)|round(3) %}

<!-- Expected processing duration -->
{% set expected_processing_duration = {} %}
{% do expected_processing_duration.update({"L1C": ((info["processing_completeness"]["L1C"]|get_timeline_duration) / 60)|round(3)}) %}
{% do expected_processing_duration.update({"L2A": ((info["processing_completeness"]["L2A"]|get_timeline_duration) / 60)|round(3)}) %}

<!-- Missing acquisition duration -->
{% set acquisition_with_no_isp_completeness_uuids = info["imaging"]|reject_events_with_link_name("ISP_COMPLETENESS")|map(attribute="event_uuid")|list %}
{% set acquisition_with_missing_isp_completeness_event_uuids = info["isp_completeness"]|map(attribute="eventTexts")|flatten|selectattr("name", "equalto", "status")|selectattr("value", "equalto", "MISSING")|map(attribute="event_uuid")|list|sort|unique|list %}
{% set missing_acquisition_duration = (((info["isp_completeness"]|selectattr("event_uuid", "in", acquisition_with_missing_isp_completeness_event_uuids)|list|get_timeline_duration) / 60) + ((info["imaging"]|selectattr("event_uuid", "in", acquisition_with_no_isp_completeness_uuids)|list|get_timeline_duration) / 60))|round(3) %}

<!-- Missing processing duration -->
{% set acquisition_with_processing_completeness_uuids = {} %}
{% set acquisition_with_no_processing_completeness_uuids = {} %}
{% set missing_processing_event_uuids = {} %}
{% set missing_processing_duration = {} %}

<!-- Missing l1c processing duration -->
{% do acquisition_with_processing_completeness_uuids.update({"L1C": info["processing_completeness"]["L1C"]|map(attribute="eventLinks")|flatten|selectattr("name", "in", ["PLANNED_IMAGING", "PLANNED_EVENT"])|map(attribute="event_uuid_link")|list}) %}
{% do acquisition_with_no_processing_completeness_uuids.update({"L1C": info["imaging"]|rejectattr("event_uuid", "in", acquisition_with_processing_completeness_uuids["L1C"])|list|map(attribute="event_uuid")|list}) %}
{% do missing_processing_event_uuids.update({"L1C": info["processing_completeness"]["L1C"]|map(attribute="eventTexts")|flatten|selectattr("name", "equalto", "status")|selectattr("value", "equalto", "MISSING")|map(attribute="event_uuid")|list|sort|unique|list}) %}
{% do missing_processing_duration.update({"L1C": (((info["processing_completeness"]["L1C"]|selectattr("event_uuid", "in", missing_processing_event_uuids["L1C"])|list|get_timeline_duration) / 60) + ((info["imaging"]|selectattr("event_uuid", "in", acquisition_with_no_processing_completeness_uuids["L1C"])|list|get_timeline_duration) / 60))|round(3)}) %}

<!-- Missing l2a processing duration -->
{% do acquisition_with_processing_completeness_uuids.update({"L2A": info["processing_completeness"]["L2A"]|map(attribute="eventLinks")|flatten|selectattr("name", "in", ["PLANNED_IMAGING", "PLANNED_EVENT"])|map(attribute="event_uuid_link")|list}) %}
{% do acquisition_with_no_processing_completeness_uuids.update({"L2A": info["imaging"]|rejectattr("event_uuid", "in", acquisition_with_processing_completeness_uuids["L2A"])|list|map(attribute="event_uuid")|list}) %}
{% do missing_processing_event_uuids.update({"L2A": info["processing_completeness"]["L2A"]|map(attribute="eventTexts")|flatten|selectattr("name", "equalto", "status")|selectattr("value", "equalto", "MISSING")|map(attribute="event_uuid")|list|sort|unique|list}) %}
{% do missing_processing_duration.update({"L2A": (((info["processing_completeness"]["L2A"]|selectattr("event_uuid", "in", missing_processing_event_uuids["L2A"])|list|get_timeline_duration) / 60) + ((info["imaging"]|selectattr("event_uuid", "in", acquisition_with_no_processing_completeness_uuids["L2A"])|list|get_timeline_duration) / 60))|round(3)}) %}

<!-- Generated tiles -->
{% set generated_tiles = {} %}

<!-- Generated l1c tiles -->
{% do generated_tiles.update({"L1C": info["tls"]["L1C"]|length}) %}

<!-- Generated l2a tiles -->
{% do generated_tiles.update({"L2A": info["tls"]["L2A"]|length}) %}

<!-- Missing dissemination to DHUS of tiles -->
{% set missing_tiles_in_dhus_annotaion_uuids = {} %}
{% set missing_tiles_in_dhus_explicit_ref_uuids = {} %}
{% set missing_tiles_in_dhus = {} %}

<!-- Missing dissemination to DHUS of l1c tiles -->
{% do missing_tiles_in_dhus_annotaion_uuids.update({"L1C": info["tls"]["L1C"]|map(attribute="annotations")|flatten|selectattr("annotationCnf.name", "equalto", "DHUS_DISSEMINATION_TIME")|map(attribute="annotationTexts")|flatten|selectattr("name", "equalto", "status")|selectattr("value", "equalto", "MISSING")|map(attribute="annotation_uuid")|list|sort|unique|list}) %}
{% do missing_tiles_in_dhus_explicit_ref_uuids.update({"L1C": info["tls"]["L1C"]|map(attribute="annotations")|flatten|selectattr("annotation_uuid", "in", missing_tiles_in_dhus_annotaion_uuids["L1C"])|map(attribute="explicit_ref_uuid")|list|sort|unique|list}) %}
{% do missing_tiles_in_dhus.update({"L1C": missing_tiles_in_dhus_explicit_ref_uuids["L1C"]|length}) %}

<!-- Missing dissemination to DHUS of l2a tiles -->
{% do missing_tiles_in_dhus_annotaion_uuids.update({"L2A": info["tls"]["L2A"]|map(attribute="annotations")|flatten|selectattr("annotationCnf.name", "equalto", "DHUS_DISSEMINATION_TIME")|map(attribute="annotationTexts")|flatten|selectattr("name", "equalto", "status")|selectattr("value", "equalto", "MISSING")|map(attribute="annotation_uuid")|list|sort|unique|list}) %}
{% do missing_tiles_in_dhus_explicit_ref_uuids.update({"L2A": info["tls"]["L2A"]|map(attribute="annotations")|flatten|selectattr("annotation_uuid", "in", missing_tiles_in_dhus_annotaion_uuids["L2A"])|map(attribute="explicit_ref_uuid")|list|sort|unique|list}) %}
{% do missing_tiles_in_dhus.update({"L2A": missing_tiles_in_dhus_explicit_ref_uuids["L2A"]|length}) %}

<!-- Missing publication to DAM of tiles -->
{% set missing_tiles_in_dam = {} %}

<!-- Missing publication to DAM of l1c tiles -->
{% do missing_tiles_in_dam.update({"L1C": info["tls"]["L1C"]|selectattr("explicit_ref_uuid", "in", missing_tiles_in_dhus_explicit_ref_uuids["L1C"])|map(attribute="annotations")|flatten|selectattr("annotationCnf.name", "equalto", "CATALOGING_TIME")|map(attribute="annotationTexts")|flatten|selectattr("name", "equalto", "status")|selectattr("value", "equalto", "MISSING")|map(attribute="annotation_uuid")|list|sort|unique|list|length}) %}

<!-- Missing publication to DAM of l2a tiles -->
{% do missing_tiles_in_dam.update({"L2A": info["tls"]["L2A"]|selectattr("explicit_ref_uuid", "in", missing_tiles_in_dhus_explicit_ref_uuids["L2A"])|map(attribute="annotations")|flatten|selectattr("annotationCnf.name", "equalto", "CATALOGING_TIME")|map(attribute="annotationTexts")|flatten|selectattr("name", "equalto", "status")|selectattr("value", "equalto", "MISSING")|map(attribute="annotation_uuid")|list|sort|unique|list|length}) %}

{% block content %}
<div class="row">
  <h1 class="page-header">Data Availability in DHUS, completeness of the datatake with UUID {{ info["imaging"][0].event_uuid }}</h1>
</div>
<!-- /.row -->

{% include "views/dhus_completeness/dhus_completeness_datatake_content.html" %}
{% endblock %}

{% block scripts %}
{{ super() }}
{% include "views/dhus_completeness/dhus_completeness_scripts.html" %}
{% endblock %}
