"""
Automated tests for the ingestion of the REP_PASS_E_EDRS files

Written by DEIMOS Space S.L. (femd)

module ingestions
"""
# Import python utilities
import os
import sys
import unittest
import datetime

# Import engine of the DDBB
import eboa.engine.engine as eboa_engine
from eboa.engine.engine import Engine
from eboa.engine.query import Query
from eboa.datamodel.base import Session, engine, Base
from eboa.engine.errors import LinksInconsistency, UndefinedEventLink, DuplicatedEventLinkRef, WrongPeriod, SourceAlreadyIngested, WrongValue, OddNumberOfCoordinates, EboaResourcesPathNotAvailable, WrongGeometry, ErrorParsingDictionary
from eboa.engine.query import Query

# Import datamodel
from eboa.datamodel.dim_signatures import DimSignature
from eboa.datamodel.events import Event, EventLink, EventKey, EventText, EventDouble, EventObject, EventGeometry, EventBoolean, EventTimestamp
from eboa.datamodel.gauges import Gauge
from eboa.datamodel.sources import Source, SourceStatus
from eboa.datamodel.explicit_refs import ExplicitRef, ExplicitRefGrp, ExplicitRefLink
from eboa.datamodel.annotations import Annotation, AnnotationCnf, AnnotationText, AnnotationDouble, AnnotationObject, AnnotationGeometry, AnnotationBoolean, AnnotationTimestamp

# Import ingestion
import eboa.ingestion.eboa_ingestion as ingestion

class TestEdrsAcquisitionIngestion(unittest.TestCase):
    def setUp(self):
        # Create the engine to manage the data
        self.engine_eboa = Engine()
        self.query_eboa = Query()

        # Create session to connectx to the database
        self.session = Session()

        # Clear all tables before executing the test
        self.query_eboa.clear_db()

    def tearDown(self):
        # Close connections to the DDBB
        self.engine_eboa.close_session()
        self.query_eboa.close_session()
        self.session.close()

    def test_insert_only_rep_pass(self):
        filename = "S2A_OPER_REP_PASS_E_CONTAINING_ALL_DATA_TO_BE_PROCESS.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_edrs_acquisition.ingestion_edrs_acquisition", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        # Check number of sources generated
        sources = self.session.query(Source).all()

        assert len(sources) == 2

        # Check that the validity period of the input has taken into consideration the MSI sensing received
        source = self.session.query(Source).filter(Source.validity_start == "2018-07-20 17:33:12.859268",
                                                   Source.validity_stop == "2018-07-21T07:37:55.121772").all()

        assert len(source) == 2

        dim_signatures = self.session.query(DimSignature).all()

        # Check number of dim_signatures generated
        assert len(dim_signatures) == 2

        dim_signature = self.session.query(DimSignature).filter(DimSignature.dim_signature == "RECEPTION_S2A").all()

        assert len(dim_signature) == 1

        dim_signature = self.session.query(DimSignature).filter(DimSignature.dim_signature == "ISP_VALIDITY_PROCESSING_COMPLETENESS_S2A").all()

        assert len(dim_signature) == 1

        # Check number of annotations generated
        annotations = self.session.query(Annotation).all()

        assert len(annotations) == 1

        # Check LINK_DETAILS annotations
        link_details = self.session.query(Annotation).join(AnnotationCnf,ExplicitRef).filter(AnnotationCnf.name == "LINK_DETAILS_CH2",
                                                                                             ExplicitRef.explicit_ref == "L20180608110336202000113").all()

        assert len(link_details) == 1

        assert link_details[0].get_structured_values() == [
            {
                "name": "session_id",
                "type": "text",
                "value": "L20180608110336202000113"
            },
            {
                "name": "downlink_orbit",
                "type": "double",
                "value": "16076.0"
            },
            {
                "name": "satellite",
                "type": "text",
                "value": "S2A"
            },
            {
                "name": "reception_station",
                "type": "text",
                "value": "EDRS"
            },
            {
                "name": "isp_status",
                "type": "text",
                "value": "COMPLETE"
            },
            {
                "name": "acquisition_status",
                "type": "text",
                "value": "COMPLETE"
            }
        ]

        # Check number of events generated
        events = self.session.query(Event).all()

        assert len(events) == 3

        # Check ISP_VALIDITY events
        playback_validity_events = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLAYBACK_VALIDITY_%")).all()

        assert len(playback_validity_events) == 2

        definite_playback_validity_event1 = self.session.query(Event).join(Gauge).filter(Gauge.name == "PLAYBACK_VALIDITY_20",
                                                                                   Event.start == "2018-07-21T07:28:23.002358",
                                                                                   Event.stop == "2018-07-21T07:37:40.689924").all()

        assert definite_playback_validity_event1[0].get_structured_values() == [
            {
                "name": "downlink_orbit",
                "type": "double",
                "value": "16076.0"
            },{
                "name": "satellite",
                "type": "text",
                "value": "S2A"
            },{
                "name": "reception_station",
                "type": "text",
                "value": "EDRS"
            },{
                "name": "channel",
                "type": "double",
                "value": "2.0"
            },{
                "name": "vcid",
                "type": "double",
                "value": "20.0"
            },{
                "name": "playback_type",
                "type": "text",
                "value": "NOMINAL"
            },{
                "name": "status",
                "type": "text",
                "value": "COMPLETE"
            }
        ]

        definite_playback_validity_event2 = self.session.query(Event).join(Gauge).filter(Gauge.name == "PLAYBACK_VALIDITY_2",
                                                                                   Event.start == "2018-07-21T07:37:41.747087",
                                                                                   Event.stop == "2018-07-21T07:37:55.121772").all()

        assert definite_playback_validity_event2[0].get_structured_values() == [
            {
                "name": "downlink_orbit",
                "type": "double",
                "value": "16076.0"
            },{
                "name": "satellite",
                "type": "text",
                "value": "S2A"
            },{
                "name": "reception_station",
                "type": "text",
                "value": "EDRS"
            },{
                "name": "channel",
                "type": "double",
                "value": "2.0"
            },{
                "name": "vcid",
                "type": "double",
                "value": "2.0"
            },{
                "name": "playback_type",
                "type": "text",
                "value": "SAD"
            },{
                "name": "status",
                "type": "text",
                "value": "COMPLETE"
            }
        ]

        raw_isp_validity_events = self.session.query(Event).join(Gauge).filter(Gauge.name == "RAW_ISP_VALIDITY").all()

        assert len(raw_isp_validity_events) == 1

        assert raw_isp_validity_events[0].get_structured_values() == [
            {
                "name": "status",
                "type": "text",
                "value": "COMPLETE"
            },{
                "name": "downlink_orbit",
                "type": "double",
                "value": "16076.0"
            },{
                "name": "satellite",
                "type": "text",
                "value": "S2A"
            },{
                "name": "reception_station",
                "type": "text",
                "value": "EDRS"
            },{
                "name": "channel",
                "type": "double",
                "value": "2.0"
            },{
                "name": "vcid",
                "type": "double",
                "value": "20.0"
            },{
                "name": "playback_type",
                "type": "text",
                "value": "NOMINAL"
            },{
                "name": "num_packets",
                "type": "double",
                "value": "1931040.0"
            },{
                "name": "num_frames",
                "type": "double",
                "value": "17927163.0"
            },{
                "name": "expected_num_packets",
                "type": "double",
                "value": "0.0"
            },{
                "name": "diff_expected_received",
                "type": "double",
                "value": "-1931040.0"
            },{
                "name": "packet_status",
                "type": "text",
                "value": "MISSING"
            }
        ]

        explicit_refs = self.session.query(ExplicitRef).all()

        assert len(explicit_refs) == 1

        definite_explicit_ref = self.session.query(ExplicitRef).join(ExplicitRefGrp).filter(ExplicitRef.explicit_ref == "L20180608110336202000113",
                                                                                    ExplicitRefGrp.name == "EDRS_LINK_SESSION_IDs").all()

        assert len(definite_explicit_ref) == 1

    #Issues to be fixed in the ingestion
    def test_insert_rep_pass_with_msi_gaps(self):

        filename = "S2A_NPPF.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_nppf.ingestion_nppf", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2A_ORBPRE.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_orbpre.ingestion_orbpre", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2__SRA.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_slot_request_edrs.ingestion_slot_request_edrs", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2A_OPER_REP_PASS_E_CONTAINING_GAPS.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_edrs_acquisition.ingestion_edrs_acquisition", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        # Check number of events generated
        events = self.session.query(Event).join(Source).filter(Source.name == "S2A_OPER_REP_PASS_E_CONTAINING_GAPS.EOF").all()

        assert len(events) == 21

        # Check number of annotations generated
        annotations = self.session.query(Annotation).all()

        assert len(annotations) == 1

        # Check that the validity period of the input has taken into consideration the MSI sensing received
        source = self.session.query(Source).filter(Source.validity_start == "2018-07-20T17:33:12.859268",
                                                   Source.validity_stop == "2018-07-21T07:37:55.121772").all()

        assert len(source) == 2

        # Check LINK_DETAILS annotations
        link_details = self.session.query(Annotation).join(AnnotationCnf).filter(AnnotationCnf.name == "LINK_DETAILS_CH2").all()

        assert len(link_details) == 1

        assert link_details[0].get_structured_values() == [
            {
                "value": "L20180608110336202000113",
                "type": "text",
                "name": "session_id"
            },{
                "value": "16076.0",
                "type": "double",
                "name": "downlink_orbit"
            },
            {
                "value": "S2A",
                "type": "text",
                "name": "satellite"
            },
            {
                "value": "EDRS",
                "type": "text",
                "name": "reception_station"
            },
            {
                "value": "INCOMPLETE",
                "type": "text",
                "name": "isp_status"
            },
            {
                "value": "COMPLETE",
                "type": "text",
                "name": "acquisition_status"
            }
        ]

        # Check RAW_ISP_VALIDITY events
        raw_isp_validities = self.session.query(Event).join(Gauge).filter(Gauge.name == "RAW_ISP_VALIDITY").all()

        assert len(raw_isp_validities) == 1

        # Check specific RAW_ISP_VALIDITY
        specific_raw_isp_validity1 = self.session.query(Event).join(Gauge).filter(Gauge.name == "RAW_ISP_VALIDITY",
                                                                                 Event.start == "2018-07-21T05:22:08.947423",
                                                                                 Event.stop == "2018-07-21T05:40:39.608000").all()

        assert len(specific_raw_isp_validity1) == 1

        assert specific_raw_isp_validity1[0].get_structured_values() == [
            {
                "name": "status",
                "value": "INCOMPLETE",
                "type": "text"
            },
            {
                "name": "downlink_orbit",
                "value": "16076.0",
                "type": "double"
            },
            {
                "name": "satellite",
                "value": "S2A",
                "type": "text"
            },
            {
                "name": "reception_station",
                "value": "EDRS",
                "type": "text"
            },
            {
                "name": "channel",
                "value": "2.0",
                "type": "double"
            },
            {
                "name": "vcid",
                "value": "20.0",
                "type": "double"
            },
            {
                "name": "playback_type",
                "value": "NOMINAL",
                "type": "text"
            },
            {
                "name": "num_packets",
                "value": "1930040.0",
                "type": "double"
            },
            {
                "name": "num_frames",
                "value": "17927163.0",
                "type": "double"
            },
            {
                "name": "expected_num_packets",
                "value": "1931040.0",
                "type": "double"
            },
            {
                "name": "diff_expected_received",
                "value": "1000.0",
                "type": "double"
            },
            {
                "name": "packet_status",
                "value": "MISSING",
                "type": "text"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((94.116896 59.067486, 93.88456100000001 58.753078, 93.656046 58.438306, 93.431241 58.123179, 93.21004000000001 57.807708, 92.99233 57.491904, 92.778008 57.175776, 92.566996 56.85933, 92.359202 56.542576, 92.15454 56.225521, 91.952922 55.908173, 91.754267 55.590539, 91.55849499999999 55.272628, 91.36553000000001 54.954444, 91.175293 54.635997, 90.987694 54.317295, 90.80268599999999 53.99834, 90.620203 53.67914, 90.440179 53.3597, 90.262552 53.040026, 90.087261 52.720123, 89.91424600000001 52.399996, 89.743452 52.079652, 89.57482299999999 51.759094, 89.40828399999999 51.43833, 89.243803 51.117362, 89.08133100000001 50.796195, 88.92082000000001 50.474832, 88.762224 50.153279, 88.605496 49.831539, 88.450592 49.509616, 88.29746900000001 49.187515, 88.146084 48.865238, 87.996387 48.542791, 87.84833999999999 48.220176, 87.701915 47.897397, 87.557074 47.574457, 87.413781 47.251358, 87.272001 46.928104, 87.13170100000001 46.604699, 86.992847 46.281144, 86.855407 45.957444, 86.719345 45.6336, 86.584621 45.309617, 86.451221 44.985496, 86.319115 44.66124, 86.188275 44.336851, 86.058674 44.012331, 85.93028700000001 43.687683, 85.803085 43.36291, 85.677046 43.038013, 85.552143 42.712994, 85.428338 42.387858, 85.305623 42.062605, 85.183975 41.737237, 85.063373 41.411757, 84.943794 41.086165, 84.825219 40.760463, 84.707627 40.434655, 84.590997 40.108741, 84.475311 39.782724, 84.36053800000001 39.456605, 84.246667 39.130387, 84.133684 38.80407, 84.02157099999999 38.477656, 83.91031 38.151147, 83.799886 37.824544, 83.690282 37.497849, 83.581481 37.171064, 83.473468 36.844189, 83.36622300000001 36.517226, 83.259727 36.190178, 83.153975 35.863045, 83.048952 35.535828, 82.944643 35.208528, 82.841036 34.881148, 82.738117 34.553688, 82.63587200000001 34.22615, 82.534289 33.898534, 82.43335500000001 33.570843, 82.33304800000001 33.243077, 82.233366 32.915238, 82.134297 32.587326, 82.035831 32.259343, 81.937956 31.93129, 81.84066 31.603167, 81.743934 31.274977, 81.64776500000001 30.94672, 81.552145 30.618397, 81.45705599999999 30.290009, 81.362492 29.961558, 81.268446 29.633044, 81.17491 29.304468, 81.081873 28.975831, 80.98932499999999 28.647135, 80.89726 28.31838, 80.805666 27.989566, 80.714536 27.660696, 80.623857 27.331769, 80.53362 27.002788, 80.44382299999999 26.673752, 80.354456 26.344663, 80.265511 26.015521, 80.176982 25.686328, 80.08886 25.357084, 80.001137 25.02779, 79.91380700000001 24.698446, 79.82686099999999 24.369055, 79.740287 24.039616, 79.654084 23.71013, 79.568246 23.380599, 79.482766 23.051023, 79.39763600000001 22.721402, 79.31285 22.391737, 79.228403 22.06203, 79.14428599999999 21.732281, 79.060495 21.402491, 78.977019 21.072661, 78.893855 20.74279, 78.810999 20.412881, 78.728444 20.082933, 78.646185 19.752948, 78.564216 19.422927, 78.48253099999999 19.092869, 78.40112499999999 18.762776, 78.319992 18.432648, 78.239126 18.102486, 78.15852099999999 17.772291, 78.07817300000001 17.442064, 77.99807800000001 17.111804, 77.91823100000001 16.781514, 77.838626 16.451193, 77.759259 16.120842, 77.680125 15.790462, 77.601218 15.460054, 77.52253399999999 15.129617, 77.444067 14.799154, 77.365813 14.468664, 77.28776999999999 14.138149, 77.209931 13.807608, 77.132293 13.477042, 77.05485 13.146453, 76.9776 12.81584, 76.900537 12.485205, 76.823656 12.154548, 76.746954 11.823869, 76.670427 11.49317, 76.59407 11.162451, 76.51788000000001 10.831712, 76.441852 10.500954, 76.365984 10.170178, 76.290269 9.839385, 76.21470600000001 9.508573999999999, 76.13928900000001 9.177747, 76.064015 8.846904, 75.98887999999999 8.516045999999999, 75.913881 8.185174, 75.83901400000001 7.854287, 75.764275 7.523387, 75.68965900000001 7.192474, 75.615165 6.861549, 75.54078699999999 6.530613, 75.466522 6.199665, 75.392368 5.868708, 75.318321 5.53774, 75.244377 5.206763, 75.17053199999999 4.875777, 75.096782 4.544783, 75.02312499999999 4.213782, 74.949557 3.882774, 74.876074 3.551759, 74.802672 3.220739, 74.729349 2.889714, 74.656104 2.558683, 74.582931 2.227649, 74.509827 1.896612, 74.436787 1.565571, 74.363809 1.234528, 74.29089 0.903483, 74.218025 0.572438, 74.145213 0.241391, 74.07244900000001 -0.089656, 73.99973300000001 -0.420702, 73.92706 -0.7517470000000001, 73.854427 -1.082791, 73.781828 -1.413832, 73.709262 -1.744871, 73.636725 -2.075906, 73.564213 -2.406938, 73.491724 -2.737966, 73.419254 -3.068988, 73.34680299999999 -3.400005, 73.274367 -3.731016, 73.20194100000001 -4.062021, 73.129521 -4.393018, 73.057104 -4.724008, 72.98468699999999 -5.05499, 72.912267 -5.385963, 72.839839 -5.716926, 72.767402 -6.04788, 70.22125800000001 -5.482112, 70.295317 -5.15132, 70.36927799999999 -4.82051, 70.443145 -4.489683, 70.51692199999999 -4.15884, 70.59061199999999 -3.827981, 70.664219 -3.497108, 70.737746 -3.16622, 70.811196 -2.835318, 70.88457099999999 -2.504403, 70.957875 -2.173475, 71.03111199999999 -1.842534, 71.104287 -1.511582, 71.177401 -1.180618, 71.25045799999999 -0.849645, 71.32346200000001 -0.518661, 71.396417 -0.187668, 71.469324 0.143334, 71.542188 0.474344, 71.615008 0.805362, 71.687791 1.136388, 71.76054000000001 1.46742, 71.833259 1.798458, 71.905951 2.129501, 71.97861899999999 2.46055, 72.051267 2.791602, 72.123897 3.122659, 72.19651399999999 3.453719, 72.269114 3.784782, 72.341707 4.115847, 72.414295 4.446914, 72.48688199999999 4.777982, 72.559471 5.10905, 72.63206599999999 5.440119, 72.704669 5.771187, 72.77728500000001 6.102253, 72.84991599999999 6.433318, 72.922561 6.764382, 72.995226 7.095442, 73.06791699999999 7.4265, 73.140635 7.757553, 73.213386 8.088602, 73.28617199999999 8.419646999999999, 73.358997 8.750685000000001, 73.431864 9.081718, 73.50477600000001 9.412744, 73.577735 9.743764000000001, 73.650741 10.074776, 73.72380200000001 10.40578, 73.79692300000001 10.736775, 73.87010600000001 11.067761, 73.94335599999999 11.398737, 74.016676 11.729703, 74.090069 12.060658, 74.163539 12.391601, 74.23709100000001 12.722533, 74.310716 13.053453, 74.38442999999999 13.384359, 74.458236 13.715252, 74.53213599999999 14.046132, 74.60613600000001 14.376996, 74.680239 14.707845, 74.75444899999999 15.038679, 74.82877000000001 15.369496, 74.903206 15.700296, 74.977752 16.03108, 75.05241700000001 16.361846, 75.12720899999999 16.692593, 75.20213200000001 17.023322, 75.27718900000001 17.354031, 75.352386 17.68472, 75.427725 18.015388, 75.503212 18.346035, 75.578851 18.676661, 75.65464 19.007264, 75.730583 19.337845, 75.806691 19.668403, 75.88296800000001 19.998937, 75.959418 20.329447, 76.03604799999999 20.659931, 76.11286 20.990391, 76.18986099999999 21.320824, 76.267055 21.65123, 76.34444499999999 21.981609, 76.422025 22.311961, 76.499813 22.642285, 76.57781300000001 22.97258, 76.656032 23.302845, 76.73447299999999 23.633081, 76.813143 23.963286, 76.892048 24.293459, 76.971191 24.623601, 77.05058 24.953711, 77.130207 25.283789, 77.210087 25.613833, 77.290229 25.943843, 77.37063999999999 26.273818, 77.451325 26.603759, 77.53229 26.933663, 77.613542 27.263531, 77.695087 27.593362, 77.776931 27.923155, 77.859073 28.25291, 77.941519 28.582628, 78.02428399999999 28.912305, 78.107376 29.241942, 78.19080200000001 29.571539, 78.274568 29.901094, 78.358682 30.230608, 78.443152 30.560078, 78.527986 30.889505, 78.613186 31.218889, 78.69875 31.548228, 78.784701 31.877523, 78.871047 32.206771, 78.957797 32.535973, 79.04495900000001 32.865127, 79.132542 33.194233, 79.220555 33.52329, 79.30900699999999 33.852298, 79.397907 34.181255, 79.487246 34.510163, 79.57705 34.839019, 79.667332 35.167822, 79.75810199999999 35.496573, 79.849369 35.825269, 79.94114500000001 36.15391, 80.03344 36.482496, 80.126265 36.811025, 80.219633 37.139497, 80.31353900000001 37.467912, 80.408002 37.796268, 80.50304199999999 38.124565, 80.59867199999999 38.4528, 80.69490399999999 38.780975, 80.791751 39.109086, 80.889228 39.437134, 80.987346 39.765118, 81.086122 40.093036, 81.185559 40.420889, 81.28566499999999 40.748675, 81.386471 41.076393, 81.487993 41.404041, 81.59024700000001 41.731619, 81.69324899999999 42.059126, 81.797015 42.386559, 81.901563 42.713919, 82.00691 43.041203, 82.113073 43.368412, 82.220046 43.695545, 82.327873 44.022599, 82.43657399999999 44.349573, 82.54616900000001 44.676467, 82.656679 45.003277, 82.768125 45.330004, 82.880529 45.656645, 82.99391300000001 45.983199, 83.1083 46.309665, 83.223692 46.636042, 83.340126 46.962329, 83.45763700000001 47.288523, 83.576249 47.614622, 83.69598999999999 47.940625, 83.816886 48.26653, 83.93896700000001 48.592335, 84.06226100000001 48.918038, 84.18679899999999 49.243637, 84.312595 49.569132, 84.439679 49.894521, 84.568101 50.2198, 84.697895 50.544967, 84.82909600000001 50.87002, 84.961741 51.194957, 85.095866 51.519775, 85.23151 51.844472, 85.368713 52.169045, 85.50751099999999 52.493492, 85.647919 52.817813, 85.790013 53.142002, 85.93383799999999 53.466057, 86.079441 53.789974, 86.226871 54.11375, 86.376178 54.437383, 86.527413 54.760868, 86.68063100000001 55.084203, 86.835888 55.407383, 86.993207 55.730409, 87.152675 56.053274, 87.31436100000001 56.375973, 87.478329 56.698503, 87.64464700000001 57.020859, 87.813383 57.343036, 87.98461 57.665031, 88.158402 57.986837, 88.334838 58.308451, 88.513972 58.629869, 88.695893 58.951086, 88.880709 59.272094, 89.06851 59.592888, 89.25939099999999 59.91346, 94.116896 59.067486))"
                    }
                ]
            }
        ]

        # Check ISP_GAPs events
        isp_gap_events = self.session.query(Event).join(Gauge).filter(Gauge.name.like("ISP_GAP")).all()

        assert len(isp_gap_events) == 3

        # Check definite ISP_GAP
        isp_gap_event1 = self.session.query(Event).join(Gauge).filter(Gauge.name == "ISP_GAP",
                                                                                 Event.start == "2018-07-21T05:22:08.947423",
                                                                                 Event.stop == "2018-07-21T05:40:39.608000").all()

        assert len(isp_gap_event1) == 1

        assert isp_gap_event1[0].get_structured_values() == [
            {
                "name": "impact",
                "value": "COMPLETE",
                "type": "text"
            },
            {
                "name": "band",
                "value": "1",
                "type": "text"
            },
            {
                "name": "detector",
                "value": "6.0",
                "type": "double"
            },
            {
                "name": "downlink_orbit",
                "value": "16076.0",
                "type": "double"
            },
            {
                "name": "satellite",
                "value": "S2A",
                "type": "text"
            },
            {
                "name": "reception_station",
                "value": "EDRS",
                "type": "text"
            },
            {
                "name": "channel",
                "value": "2.0",
                "type": "double"
            },
            {
                "name": "vcid",
                "value": "20.0",
                "type": "double"
            },
            {
                "name": "playback_type",
                "value": "NOMINAL",
                "type": "text"
            },
            {
                "name": "apid",
                "value": "256.0",
                "type": "double"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((94.116896 59.067486, 93.88456100000001 58.753078, 93.656046 58.438306, 93.431241 58.123179, 93.21004000000001 57.807708, 92.99233 57.491904, 92.778008 57.175776, 92.566996 56.85933, 92.359202 56.542576, 92.15454 56.225521, 91.952922 55.908173, 91.754267 55.590539, 91.55849499999999 55.272628, 91.36553000000001 54.954444, 91.175293 54.635997, 90.987694 54.317295, 90.80268599999999 53.99834, 90.620203 53.67914, 90.440179 53.3597, 90.262552 53.040026, 90.087261 52.720123, 89.91424600000001 52.399996, 89.743452 52.079652, 89.57482299999999 51.759094, 89.40828399999999 51.43833, 89.243803 51.117362, 89.08133100000001 50.796195, 88.92082000000001 50.474832, 88.762224 50.153279, 88.605496 49.831539, 88.450592 49.509616, 88.29746900000001 49.187515, 88.146084 48.865238, 87.996387 48.542791, 87.84833999999999 48.220176, 87.701915 47.897397, 87.557074 47.574457, 87.413781 47.251358, 87.272001 46.928104, 87.13170100000001 46.604699, 86.992847 46.281144, 86.855407 45.957444, 86.719345 45.6336, 86.584621 45.309617, 86.451221 44.985496, 86.319115 44.66124, 86.188275 44.336851, 86.058674 44.012331, 85.93028700000001 43.687683, 85.803085 43.36291, 85.677046 43.038013, 85.552143 42.712994, 85.428338 42.387858, 85.305623 42.062605, 85.183975 41.737237, 85.063373 41.411757, 84.943794 41.086165, 84.825219 40.760463, 84.707627 40.434655, 84.590997 40.108741, 84.475311 39.782724, 84.36053800000001 39.456605, 84.246667 39.130387, 84.133684 38.80407, 84.02157099999999 38.477656, 83.91031 38.151147, 83.799886 37.824544, 83.690282 37.497849, 83.581481 37.171064, 83.473468 36.844189, 83.36622300000001 36.517226, 83.259727 36.190178, 83.153975 35.863045, 83.048952 35.535828, 82.944643 35.208528, 82.841036 34.881148, 82.738117 34.553688, 82.63587200000001 34.22615, 82.534289 33.898534, 82.43335500000001 33.570843, 82.33304800000001 33.243077, 82.233366 32.915238, 82.134297 32.587326, 82.035831 32.259343, 81.937956 31.93129, 81.84066 31.603167, 81.743934 31.274977, 81.64776500000001 30.94672, 81.552145 30.618397, 81.45705599999999 30.290009, 81.362492 29.961558, 81.268446 29.633044, 81.17491 29.304468, 81.081873 28.975831, 80.98932499999999 28.647135, 80.89726 28.31838, 80.805666 27.989566, 80.714536 27.660696, 80.623857 27.331769, 80.53362 27.002788, 80.44382299999999 26.673752, 80.354456 26.344663, 80.265511 26.015521, 80.176982 25.686328, 80.08886 25.357084, 80.001137 25.02779, 79.91380700000001 24.698446, 79.82686099999999 24.369055, 79.740287 24.039616, 79.654084 23.71013, 79.568246 23.380599, 79.482766 23.051023, 79.39763600000001 22.721402, 79.31285 22.391737, 79.228403 22.06203, 79.14428599999999 21.732281, 79.060495 21.402491, 78.977019 21.072661, 78.893855 20.74279, 78.810999 20.412881, 78.728444 20.082933, 78.646185 19.752948, 78.564216 19.422927, 78.48253099999999 19.092869, 78.40112499999999 18.762776, 78.319992 18.432648, 78.239126 18.102486, 78.15852099999999 17.772291, 78.07817300000001 17.442064, 77.99807800000001 17.111804, 77.91823100000001 16.781514, 77.838626 16.451193, 77.759259 16.120842, 77.680125 15.790462, 77.601218 15.460054, 77.52253399999999 15.129617, 77.444067 14.799154, 77.365813 14.468664, 77.28776999999999 14.138149, 77.209931 13.807608, 77.132293 13.477042, 77.05485 13.146453, 76.9776 12.81584, 76.900537 12.485205, 76.823656 12.154548, 76.746954 11.823869, 76.670427 11.49317, 76.59407 11.162451, 76.51788000000001 10.831712, 76.441852 10.500954, 76.365984 10.170178, 76.290269 9.839385, 76.21470600000001 9.508573999999999, 76.13928900000001 9.177747, 76.064015 8.846904, 75.98887999999999 8.516045999999999, 75.913881 8.185174, 75.83901400000001 7.854287, 75.764275 7.523387, 75.68965900000001 7.192474, 75.615165 6.861549, 75.54078699999999 6.530613, 75.466522 6.199665, 75.392368 5.868708, 75.318321 5.53774, 75.244377 5.206763, 75.17053199999999 4.875777, 75.096782 4.544783, 75.02312499999999 4.213782, 74.949557 3.882774, 74.876074 3.551759, 74.802672 3.220739, 74.729349 2.889714, 74.656104 2.558683, 74.582931 2.227649, 74.509827 1.896612, 74.436787 1.565571, 74.363809 1.234528, 74.29089 0.903483, 74.218025 0.572438, 74.145213 0.241391, 74.07244900000001 -0.089656, 73.99973300000001 -0.420702, 73.92706 -0.7517470000000001, 73.854427 -1.082791, 73.781828 -1.413832, 73.709262 -1.744871, 73.636725 -2.075906, 73.564213 -2.406938, 73.491724 -2.737966, 73.419254 -3.068988, 73.34680299999999 -3.400005, 73.274367 -3.731016, 73.20194100000001 -4.062021, 73.129521 -4.393018, 73.057104 -4.724008, 72.98468699999999 -5.05499, 72.912267 -5.385963, 72.839839 -5.716926, 72.767402 -6.04788, 70.22125800000001 -5.482112, 70.295317 -5.15132, 70.36927799999999 -4.82051, 70.443145 -4.489683, 70.51692199999999 -4.15884, 70.59061199999999 -3.827981, 70.664219 -3.497108, 70.737746 -3.16622, 70.811196 -2.835318, 70.88457099999999 -2.504403, 70.957875 -2.173475, 71.03111199999999 -1.842534, 71.104287 -1.511582, 71.177401 -1.180618, 71.25045799999999 -0.849645, 71.32346200000001 -0.518661, 71.396417 -0.187668, 71.469324 0.143334, 71.542188 0.474344, 71.615008 0.805362, 71.687791 1.136388, 71.76054000000001 1.46742, 71.833259 1.798458, 71.905951 2.129501, 71.97861899999999 2.46055, 72.051267 2.791602, 72.123897 3.122659, 72.19651399999999 3.453719, 72.269114 3.784782, 72.341707 4.115847, 72.414295 4.446914, 72.48688199999999 4.777982, 72.559471 5.10905, 72.63206599999999 5.440119, 72.704669 5.771187, 72.77728500000001 6.102253, 72.84991599999999 6.433318, 72.922561 6.764382, 72.995226 7.095442, 73.06791699999999 7.4265, 73.140635 7.757553, 73.213386 8.088602, 73.28617199999999 8.419646999999999, 73.358997 8.750685000000001, 73.431864 9.081718, 73.50477600000001 9.412744, 73.577735 9.743764000000001, 73.650741 10.074776, 73.72380200000001 10.40578, 73.79692300000001 10.736775, 73.87010600000001 11.067761, 73.94335599999999 11.398737, 74.016676 11.729703, 74.090069 12.060658, 74.163539 12.391601, 74.23709100000001 12.722533, 74.310716 13.053453, 74.38442999999999 13.384359, 74.458236 13.715252, 74.53213599999999 14.046132, 74.60613600000001 14.376996, 74.680239 14.707845, 74.75444899999999 15.038679, 74.82877000000001 15.369496, 74.903206 15.700296, 74.977752 16.03108, 75.05241700000001 16.361846, 75.12720899999999 16.692593, 75.20213200000001 17.023322, 75.27718900000001 17.354031, 75.352386 17.68472, 75.427725 18.015388, 75.503212 18.346035, 75.578851 18.676661, 75.65464 19.007264, 75.730583 19.337845, 75.806691 19.668403, 75.88296800000001 19.998937, 75.959418 20.329447, 76.03604799999999 20.659931, 76.11286 20.990391, 76.18986099999999 21.320824, 76.267055 21.65123, 76.34444499999999 21.981609, 76.422025 22.311961, 76.499813 22.642285, 76.57781300000001 22.97258, 76.656032 23.302845, 76.73447299999999 23.633081, 76.813143 23.963286, 76.892048 24.293459, 76.971191 24.623601, 77.05058 24.953711, 77.130207 25.283789, 77.210087 25.613833, 77.290229 25.943843, 77.37063999999999 26.273818, 77.451325 26.603759, 77.53229 26.933663, 77.613542 27.263531, 77.695087 27.593362, 77.776931 27.923155, 77.859073 28.25291, 77.941519 28.582628, 78.02428399999999 28.912305, 78.107376 29.241942, 78.19080200000001 29.571539, 78.274568 29.901094, 78.358682 30.230608, 78.443152 30.560078, 78.527986 30.889505, 78.613186 31.218889, 78.69875 31.548228, 78.784701 31.877523, 78.871047 32.206771, 78.957797 32.535973, 79.04495900000001 32.865127, 79.132542 33.194233, 79.220555 33.52329, 79.30900699999999 33.852298, 79.397907 34.181255, 79.487246 34.510163, 79.57705 34.839019, 79.667332 35.167822, 79.75810199999999 35.496573, 79.849369 35.825269, 79.94114500000001 36.15391, 80.03344 36.482496, 80.126265 36.811025, 80.219633 37.139497, 80.31353900000001 37.467912, 80.408002 37.796268, 80.50304199999999 38.124565, 80.59867199999999 38.4528, 80.69490399999999 38.780975, 80.791751 39.109086, 80.889228 39.437134, 80.987346 39.765118, 81.086122 40.093036, 81.185559 40.420889, 81.28566499999999 40.748675, 81.386471 41.076393, 81.487993 41.404041, 81.59024700000001 41.731619, 81.69324899999999 42.059126, 81.797015 42.386559, 81.901563 42.713919, 82.00691 43.041203, 82.113073 43.368412, 82.220046 43.695545, 82.327873 44.022599, 82.43657399999999 44.349573, 82.54616900000001 44.676467, 82.656679 45.003277, 82.768125 45.330004, 82.880529 45.656645, 82.99391300000001 45.983199, 83.1083 46.309665, 83.223692 46.636042, 83.340126 46.962329, 83.45763700000001 47.288523, 83.576249 47.614622, 83.69598999999999 47.940625, 83.816886 48.26653, 83.93896700000001 48.592335, 84.06226100000001 48.918038, 84.18679899999999 49.243637, 84.312595 49.569132, 84.439679 49.894521, 84.568101 50.2198, 84.697895 50.544967, 84.82909600000001 50.87002, 84.961741 51.194957, 85.095866 51.519775, 85.23151 51.844472, 85.368713 52.169045, 85.50751099999999 52.493492, 85.647919 52.817813, 85.790013 53.142002, 85.93383799999999 53.466057, 86.079441 53.789974, 86.226871 54.11375, 86.376178 54.437383, 86.527413 54.760868, 86.68063100000001 55.084203, 86.835888 55.407383, 86.993207 55.730409, 87.152675 56.053274, 87.31436100000001 56.375973, 87.478329 56.698503, 87.64464700000001 57.020859, 87.813383 57.343036, 87.98461 57.665031, 88.158402 57.986837, 88.334838 58.308451, 88.513972 58.629869, 88.695893 58.951086, 88.880709 59.272094, 89.06851 59.592888, 89.25939099999999 59.91346, 94.116896 59.067486))"
                    }
                ]
            }
        ]
        
        isp_gap_event2 = self.session.query(Event).join(Gauge).filter(Gauge.name == "ISP_GAP",
                                                                                 Event.start == "2018-07-21T05:22:08.947423",
                                                                                 Event.stop == "2018-07-21T05:30:08.947423").all()

        assert len(isp_gap_event2) == 1

        assert isp_gap_event2[0].get_structured_values() == [
            {
                "name": "impact",
                "value": "AT_THE_BEGINNING",
                "type": "text"
            },
            {
                "name": "band",
                "value": "3",
                "type": "text"
            },
            {
                "name": "detector",
                "value": "6.0",
                "type": "double"
            },
            {
                "name": "downlink_orbit",
                "value": "16076.0",
                "type": "double"
            },
            {
                "name": "satellite",
                "value": "S2A",
                "type": "text"
            },
            {
                "name": "reception_station",
                "value": "EDRS",
                "type": "text"
            },
            {
                "name": "channel",
                "value": "2.0",
                "type": "double"
            },
            {
                "name": "vcid",
                "value": "20.0",
                "type": "double"
            },
            {
                "name": "playback_type",
                "value": "NOMINAL",
                "type": "text"
            },
            {
                "name": "apid",
                "value": "258.0",
                "type": "double"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((94.116896 59.067486, 93.966227 58.864219, 93.817177 58.660797, 93.669667 58.457229, 93.52373299999999 58.253511, 93.379346 58.049644, 93.236423 57.845638, 93.094965 57.641492, 92.954972 57.437206, 92.81640299999999 57.232782, 92.679182 57.028232, 92.543346 56.823547, 92.408873 56.618731, 92.275689 56.413792, 92.143792 56.20873, 92.013186 56.003543, 91.883841 55.798234, 91.75567700000001 55.592812, 91.628739 55.387272, 91.503005 55.181614, 91.378412 54.975847, 91.254953 54.76997, 91.132639 54.563983, 91.011444 54.357886, 90.89129 54.151689, 90.772223 53.945385, 90.654225 53.738978, 90.53724200000001 53.532472, 90.421262 53.325868, 90.306299 53.119164, 90.192336 52.912362, 90.079292 52.705471, 89.96721700000001 52.498485, 89.856095 52.291405, 89.745878 52.084235, 89.63655199999999 51.876979, 89.52813399999999 51.669632, 89.420609 51.462197, 89.313903 51.254682, 89.208062 51.04708, 89.103072 50.839394, 88.99889400000001 50.631627, 88.895509 50.423782, 88.79293699999999 50.215855, 88.691165 50.007848, 88.59012800000001 49.799768, 88.489863 49.59161, 88.390362 49.383376, 88.291591 49.175068, 88.193528 48.966689, 88.09619600000001 48.758236, 87.999583 48.54971, 87.903631 48.341118, 87.80837099999999 48.132455, 87.71379899999999 47.923722, 87.61988599999999 47.714923, 87.526606 47.506058, 87.43398500000001 47.297126, 87.342012 47.088129, 87.250636 46.879069, 87.159881 46.669946, 87.06974700000001 46.460759, 86.98021 46.25151, 86.89124099999999 46.042203, 86.802868 45.832834, 86.715081 45.623404, 86.627833 45.413918, 86.541146 45.204373, 86.45502 44.99477, 86.36943599999999 44.78511, 86.284364 44.575397, 86.19983000000001 44.365627, 86.11582900000001 44.155801, 86.03231700000001 43.945923, 85.94931 43.735992, 85.86681299999999 43.526007, 85.78480999999999 43.315969, 85.703267 43.105883, 85.622214 42.895744, 85.54164400000001 42.685554, 85.461521 42.475316, 85.38185300000001 42.265028, 85.30265 42.054692, 85.22389699999999 41.844306, 85.14555900000001 41.633876, 85.067668 41.423397, 84.990216 41.212871, 84.91317100000001 41.0023, 84.83654 40.791685, 84.76033200000001 40.581023, 84.684535 40.370317, 84.609115 40.159568, 84.53410100000001 39.948775, 84.45948799999999 39.737939, 84.385248 39.527061, 84.31138300000001 39.316141, 84.237904 39.105179, 84.16480199999999 38.894175, 84.09204200000001 38.683133, 84.01965199999999 38.472049, 83.94762900000001 38.260925, 83.87594799999999 38.049762, 83.804607 37.838561, 83.733619 37.62732, 83.66297900000001 37.416041, 83.592647 37.204725, 83.522655 36.993372, 83.45299900000001 36.781981, 83.383656 36.570554, 83.314623 36.359091, 83.245913 36.147592, 83.177522 35.936056, 83.109413 35.724488, 83.04161499999999 35.512883, 82.974124 35.301244, 82.906921 35.089572, 82.840001 34.877866, 82.773377 34.666126, 82.70704499999999 34.454353, 82.640973 34.242549, 82.575185 34.030712, 82.50967799999999 33.818842, 82.44443699999999 33.606941, 82.379453 33.395009, 82.314742 33.183046, 82.250298 32.971052, 82.186094 32.759028, 82.122148 32.546974, 82.05846200000001 32.334889, 81.99502 32.122776, 81.931814 31.910634, 81.86885700000001 31.698462, 81.806146 31.486262, 81.743657 31.274034, 78.784454 31.876577, 78.84025699999999 32.089486, 78.896199 32.302377, 78.952324 32.515248, 79.008636 32.728098, 79.065102 32.94093, 79.12174 33.153741, 79.178572 33.366532, 79.23559299999999 33.579301, 79.292766 33.792051, 79.350139 34.00478, 79.40771700000001 34.217487, 79.465468 34.430173, 79.52340599999999 34.642838, 79.58155600000001 34.855481, 79.639917 35.068101, 79.698443 35.280701, 79.757189 35.493278, 79.816159 35.705831, 79.87532400000001 35.918362, 79.934692 36.130871, 79.994292 36.343356, 80.05412699999999 36.555817, 80.114142 36.768256, 80.17439899999999 36.98067, 80.23490099999999 37.19306, 80.295621 37.405426, 80.356562 37.617768, 80.41775800000001 37.830085, 80.479213 38.042375, 80.540869 38.254642, 80.602788 38.466884, 80.66497699999999 38.679098, 80.72740899999999 38.891287, 80.790082 39.103451, 80.853036 39.315588, 80.916273 39.527696, 80.979737 39.73978, 81.043488 39.951836, 81.107535 40.163864, 81.171854 40.375864, 81.236437 40.587837, 81.301328 40.799781, 81.36653 41.011695, 81.431989 41.223583, 81.49776 41.435441, 81.563856 41.647268, 81.630257 41.859066, 81.69694699999999 42.070835, 81.763975 42.282573, 81.83134699999999 42.494279, 81.89900799999999 42.705956, 81.96701 42.917602, 82.03537 43.129214, 82.104071 43.340795, 82.17309 43.552346, 82.242482 43.763862, 82.312253 43.975344, 82.382349 44.186796, 82.45281900000001 44.398213, 82.523684 44.609595, 82.594931 44.820943, 82.666528 45.032258, 82.73853699999999 45.243537, 82.81096599999999 45.454779, 82.88376100000001 45.665987, 82.95696700000001 45.877159, 83.03061 46.088293, 83.10468 46.29939, 83.179137 46.510451, 83.254052 46.721474, 83.32943 46.932456, 83.40522300000001 47.143402, 83.48146800000001 47.354309, 83.558198 47.565175, 83.635406 47.776, 83.71304499999999 47.986788, 83.791191 48.197533, 83.86985300000001 48.408234, 83.948982 48.618896, 84.028612 48.829516, 84.10878099999999 49.040091, 84.189488 49.250622, 84.270674 49.461112, 84.352425 49.671556, 84.43474999999999 49.881953, 84.51760400000001 50.092306, 84.60101400000001 50.302614, 84.68502599999999 50.512872, 84.769642 50.723082, 84.854795 50.933249, 84.940579 51.143364, 85.02700400000001 51.353428, 85.11403 51.563444, 85.20167499999999 51.773411, 85.28999399999999 51.983324, 85.378995 52.193183, 85.468598 52.402995, 85.558908 52.612751, 85.64993800000001 52.822451, 85.741649 53.032097, 85.834056 53.24169, 85.927218 53.451223, 86.021151 53.660697, 86.11576599999999 53.870119, 86.211175 54.079479, 86.307395 54.288777, 86.404391 54.498016, 86.50216899999999 54.707196, 86.60080000000001 54.91631, 86.7003 55.125358, 86.800583 55.334348, 86.90176 55.54327, 87.003851 55.752124, 87.106831 55.96091, 87.210695 56.169632, 87.31552499999999 56.378281, 87.42134 56.586856, 87.528057 56.795365, 87.635783 57.0038, 87.74454900000001 57.212157, 87.854333 57.420439, 87.96512300000001 57.628649, 88.07701299999999 57.836777, 88.19002399999999 58.044823, 88.304078 58.252794, 88.41927800000001 58.460682, 88.53566499999999 58.668483, 88.65322399999999 58.876199, 88.771934 59.083833, 88.891903 59.291376, 89.013155 59.498826, 89.13561799999999 59.70619, 89.25939099999999 59.91346, 94.116896 59.067486))"
                    }
                ]
            }
        ]

        isp_gap_event3 = self.session.query(Event).join(Gauge).filter(Gauge.name == "ISP_GAP",
                                                                                 Event.start == "2018-07-21T05:35:36",
                                                                                 Event.stop == "2018-07-21T05:40:39.608000").all()

        assert len(isp_gap_event3) == 1

        assert isp_gap_event3[0].get_structured_values() == [
            {
                "name": "impact",
                "value": "AT_THE_END",
                "type": "text"
            },
            {
                "name": "band",
                "value": "4",
                "type": "text"
            },
            {
                "name": "detector",
                "value": "6.0",
                "type": "double"
            },
            {
                "name": "downlink_orbit",
                "value": "16076.0",
                "type": "double"
            },
            {
                "name": "satellite",
                "value": "S2A",
                "type": "text"
            },
            {
                "name": "reception_station",
                "value": "EDRS",
                "type": "text"
            },
            {
                "name": "channel",
                "value": "2.0",
                "type": "double"
            },
            {
                "name": "vcid",
                "value": "20.0",
                "type": "double"
            },
            {
                "name": "playback_type",
                "value": "NOMINAL",
                "type": "text"
            },
            {
                "name": "apid",
                "value": "259.0",
                "type": "double"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((76.777479 11.955565, 76.72785500000001 11.741412, 76.67830499999999 11.527251, 76.628826 11.313081, 76.579418 11.098903, 76.530079 10.884717, 76.48080899999999 10.670523, 76.431606 10.456321, 76.382469 10.242112, 76.333398 10.027895, 76.28439 9.813670999999999, 76.235446 9.599439, 76.186564 9.385201, 76.137742 9.170956, 76.088981 8.956704, 76.040279 8.742445999999999, 75.991634 8.528181999999999, 75.943046 8.313910999999999, 75.894514 8.099634999999999, 75.846037 7.885353, 75.797613 7.671065, 75.749244 7.456771, 75.700925 7.242473, 75.652657 7.028169, 75.604439 6.81386, 75.556271 6.599546, 75.508149 6.385228, 75.46007400000001 6.170905, 75.412047 5.956578, 75.364064 5.742246, 75.316124 5.527911, 75.268227 5.313572, 75.220375 5.099229, 75.172562 4.884882, 75.124788 4.670532, 75.077056 4.456179, 75.02936200000001 4.241823, 74.981703 4.027464, 74.93408100000001 3.813102, 74.886498 3.598737, 74.838947 3.38437, 74.791428 3.170001, 74.74394599999999 2.955629, 74.696495 2.741256, 74.649072 2.526881, 74.60168 2.312504, 74.55432 2.098125, 74.506987 1.883746, 74.459678 1.669364, 74.41240000000001 1.454982, 74.36514699999999 1.240599, 74.31791699999999 1.026216, 74.270708 0.811831, 74.223529 0.597446, 74.176368 0.383061, 74.129226 0.168676, 74.08210699999999 -0.045709, 74.03501 -0.260094, 73.987927 -0.474479, 73.940859 -0.688863, 73.893816 -0.903247, 73.846785 -1.11763, 73.79976600000001 -1.332012, 73.752764 -1.546393, 73.705777 -1.760772, 73.658799 -1.975151, 73.611829 -2.189528, 73.56487799999999 -2.403903, 73.517934 -2.618276, 73.470995 -2.832647, 73.424065 -3.047017, 73.37714699999999 -3.261384, 73.330231 -3.475748, 73.283316 -3.69011, 73.236414 -3.904469, 73.189514 -4.118826, 73.142611 -4.333179, 73.09571200000001 -4.547529, 73.04881899999999 -4.761876, 73.001921 -4.97622, 72.955018 -5.19056, 72.908123 -5.404896, 72.861223 -5.619228, 72.814314 -5.833556, 72.767402 -6.04788, 70.22125800000001 -5.482112, 70.269229 -5.267893, 70.317159 -5.053667, 70.36505 -4.839434, 70.41290100000001 -4.625194, 70.460712 -4.410947, 70.508486 -4.196693, 70.556225 -3.982433, 70.603926 -3.768166, 70.65159199999999 -3.553892, 70.699226 -3.339613, 70.74682799999999 -3.125328, 70.794394 -2.911037, 70.84193 -2.69674, 70.889438 -2.482438, 70.936915 -2.26813, 70.984362 -2.053817, 71.031784 -1.839499, 71.07918100000001 -1.625177, 71.126547 -1.410849, 71.17389 -1.196517, 71.22121199999999 -0.982181, 71.26850899999999 -0.76784, 71.315781 -0.553495, 71.363035 -0.339146, 71.41027200000001 -0.124794, 71.457482 0.089563, 71.504676 0.303923, 71.551855 0.518286, 71.59901600000001 0.732653, 71.646158 0.9470229999999999, 71.693287 1.161395, 71.74040599999999 1.37577, 71.787505 1.590148, 71.834593 1.804529, 71.88167300000001 2.018911, 71.928741 2.233296, 71.97579500000001 2.447683, 72.02284400000001 2.662072, 72.06988800000001 2.876461, 72.116919 3.090854, 72.163944 3.305247, 72.210967 3.519642, 72.257987 3.734037, 72.304996 3.948435, 72.352007 4.162832, 72.39901999999999 4.37723, 72.44602500000001 4.591629, 72.493031 4.806028, 72.540041 5.020427, 72.58705500000001 5.234826, 72.634063 5.449226, 72.681079 5.663625, 72.728104 5.878024, 72.775127 6.092422, 72.82215600000001 6.30682, 72.869197 6.521216, 72.91624899999999 6.735612, 72.96329799999999 6.950007, 73.010362 7.1644, 73.05744300000001 7.378792, 73.104529 7.593183, 73.151625 7.807572, 73.198739 8.021958, 73.245873 8.236343, 73.293008 8.450726, 73.340165 8.665107000000001, 73.387345 8.879484, 73.434538 9.093859999999999, 73.481745 9.308233, 73.528978 9.522603, 73.576238 9.736969, 73.623504 9.951333, 73.670799 10.165694, 73.71812300000001 10.38005, 73.765468 10.594403, 73.812832 10.808753, 73.860229 11.023099, 73.907659 11.23744, 73.95510400000001 11.451778, 74.00258100000001 11.666111, 74.050096 11.880439, 74.09764 12.094763, 74.145207 12.309083, 74.192814 12.523397, 76.777479 11.955565))"
                    }
                ]
            }
        ]

        # Check PLAYBACKGA_Ps events
        playback_gap_events = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLAYBACK_GAP")).all()

        assert len(playback_gap_events) == 1

        # Check definite PLAYBACK_GAP
        playback_gap_event1 = self.session.query(Event).join(Gauge).filter(Gauge.name == "PLAYBACK_GAP",
                                                                                 Event.start == "2018-07-21T07:28:23.555000",
                                                                                 Event.stop == "2018-07-21T07:28:23.888999").all()

        assert len(playback_gap_event1) == 1

        assert playback_gap_event1[0].get_structured_values() == [
            {
                "type": "double",
                "name": "downlink_orbit",
                "value": "16076.0"
            },
            {
                "type": "text",
                "name": "satellite",
                "value": "S2A"
            },
            {
                "type": "text",
                "name": "reception_station",
                "value": "EDRS"
            },
            {
                "type": "double",
                "name": "channel",
                "value": "2.0"
            },
            {
                "type": "double",
                "name": "vcid",
                "value": "20.0"
            },
            {
                "type": "text",
                "name": "playback_type",
                "value": "NOMINAL"
            },
            {
                "type": "double",
                "name": "estimated_lost",
                "value": "392733.0"
            },
            {
                "type": "double",
                "name": "pre_counter",
                "value": "2399762.0"
            },
            {
                "type": "double",
                "name": "post_counter",
                "value": "2792496.0"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((41.808028 -31.018905, 38.843875 -30.412247, 38.843875 -30.412247, 41.808028 -31.018905))"
                    }
                ]
            }
        ]

    def test_insert_rep_pass_no_data(self):
        filename = "S2A_OPER_REP_PASS_E_NO_DATA.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_edrs_acquisition.ingestion_edrs_acquisition", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        # Check number of events generated
        events = self.session.query(Event).all()

        assert len(events) == 0

        # Check number of annotations generated
        annotations = self.session.query(Annotation).all()

        assert len(annotations) == 0

        # Check that the validity period of the input has taken into consideration the MSI sensing received
        source = self.session.query(Source).filter(Source.validity_start == "2018-07-21T07:28:23",
                                                   Source.validity_stop == "2018-07-21T07:37:55").all()

        assert len(source) == 1

    def test_insert_rep_pass_with_plan(self):

        filename = "S2A_NPPF.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_nppf.ingestion_nppf", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2A_ORBPRE.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_orbpre.ingestion_orbpre", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2__SRA.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_slot_request_edrs.ingestion_slot_request_edrs", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2A_OPER_REP_PASS_E_CONTAINING_ALL_DATA_TO_BE_PROCESS.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_edrs_acquisition.ingestion_edrs_acquisition", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]
        assert returned_value[1]["status"] == eboa_engine.exit_codes["OK"]["status"]

        # Check sources
        source = self.session.query(Source).filter(Source.validity_start == "2018-07-20T17:33:12.859268",
                                                   Source.validity_stop == "2018-07-21T07:37:55.121772",
                                                   Source.name == "S2A_OPER_REP_PASS_E_CONTAINING_ALL_DATA_TO_BE_PROCESS.EOF",
                                                   Source.processor == "ingestion_edrs_acquisition.py").all()

        assert len(source) == 2

        source = self.session.query(Source).filter(Source.validity_start == "2018-07-21T05:22:08.947423",
                                                   Source.validity_stop == "2018-07-21T05:40:35.417601",
                                                   Source.name == "S2A_OPER_REP_PASS_E_CONTAINING_ALL_DATA_TO_BE_PROCESS.EOF",
                                                   Source.processor == "isp_planning_completeness_ingestion_edrs_acquisition.py").all()

        assert len(source) == 1

        # Check number of events generated
        events = self.session.query(Event).join(Source).filter(Source.name == "S2A_OPER_REP_PASS_E_CONTAINING_ALL_DATA_TO_BE_PROCESS.EOF").all()

        assert len(events) == 17

        # Check PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL events
        isp_completeness_events = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL%")).all()

        assert len(isp_completeness_events) == 5

        # Check definite ISP completeness
        isp_completeness_missing_left = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL_%"),
                                                                                 Event.start == "2018-07-21T05:16:58.773036",
                                                                                 Event.stop == "2018-07-21T05:22:08.947423").all()

        assert len(isp_completeness_missing_left) == 1

        assert isp_completeness_missing_left[0].get_structured_values() == [
            {
                "type": "text",
                "value": "MPMSNOBS",
                "name": "start_request"
            },
            {
                "type": "text",
                "value": "MPMSIMID",
                "name": "stop_request"
            },
            {
                "type": "double",
                "value": "16075.0",
                "name": "start_orbit"
            },
            {
                "type": "double",
                "value": "100.3083",
                "name": "start_angle"
            },
            {
                "type": "double",
                "value": "16075.0",
                "name": "stop_orbit"
            },
            {
                "type": "double",
                "value": "171.1847",
                "name": "stop_angle"
            },
            {
                "type": "text",
                "value": "S2A",
                "name": "satellite"
            },
            {
                "type": "text",
                "value": "NOMINAL",
                "name": "record_type"
            },
            {
                "type": "text",
                "value": "NOMINAL",
                "name": "imaging_mode"
            },
            {
                "type": "object",
                "values": [
                    {
                        "type": "double",
                        "value": "0.0",
                        "name": "start_scn_dup"
                    }
                ],
                "name": "parameters"
            },
            {
                "type": "text",
                "value": "TIME_CORRECTED",
                "name": "status_correction"
            },
            {
                "type": "double",
                "value": "-5.365036",
                "name": "delta_start"
            },
            {
                "type": "double",
                "value": "-5.12251",
                "name": "delta_stop"
            },
            {
                "type": "text",
                "value": "MISSING",
                "name": "status"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((119.690177 75.29900600000001, 119.108056 75.137455, 118.53799 74.97452, 117.979688 74.810244, 117.432787 74.644687, 116.897014 74.47788799999999, 116.372162 74.309872, 115.85796 74.14067799999999, 115.354011 73.97036799999999, 114.860172 73.798956, 114.3762 73.62647200000001, 113.901807 73.452958, 113.436685 73.278457, 112.9807 73.102981, 112.533617 72.92655999999999, 112.095118 72.74923800000001, 111.665027 72.571037, 111.243173 72.39197299999999, 110.829342 72.21207200000001, 110.423202 72.031384, 110.024685 71.849908, 109.633596 71.66766699999999, 109.249693 71.484692, 108.872766 71.301011, 108.502716 71.11662800000001, 108.139367 70.931566, 107.78245 70.74585999999999, 107.431873 70.559516, 107.087504 70.372547, 106.749168 70.18497499999999, 106.416627 69.996831, 106.089841 69.80811199999999, 105.768666 69.618835, 105.452899 69.429025, 105.142412 69.238697, 104.837134 69.047853, 104.536934 68.85650800000001, 104.241583 68.664694, 103.951057 68.47240600000001, 103.665251 68.27965500000001, 103.384018 68.086459, 103.107198 67.892837, 102.834766 67.698787, 102.56662 67.50432000000001, 102.302583 67.30945699999999, 102.042593 67.114204, 101.786593 66.918564, 101.534487 66.72254700000001, 101.286081 66.526178, 101.041395 66.32944999999999, 100.800344 66.13237100000001, 100.5628 65.934957, 100.328664 65.737218, 100.09792 65.539152, 99.870492 65.340767, 99.646226 65.142084, 99.425107 64.943099, 99.207088 64.74381700000001, 98.992086 64.544247, 98.779963 64.34440499999999, 98.57074299999999 64.14428599999999, 98.36435899999999 63.943895, 98.160701 63.743246, 97.959715 63.542343, 97.76138899999999 63.341187, 97.565665 63.139782, 97.372404 62.938146, 97.181629 62.736273, 96.993296 62.534166, 96.807329 62.331835, 96.623639 62.12929, 96.442244 61.926526, 96.263096 61.723547, 96.08609199999999 61.520367, 95.911214 61.316985, 95.73845 61.113401, 95.56775500000001 60.90962, 95.399007 60.705656, 95.232249 60.501502, 95.067442 60.297162, 94.90451400000001 60.092644, 94.74341099999999 59.887954, 94.584148 59.683088, 94.426688 59.478049, 94.270933 59.272849, 94.116896 59.067486, 89.25939099999999 59.91346, 89.38592199999999 60.122933, 89.513845 60.332306, 89.643119 60.541585, 89.773871 60.750758, 89.906133 60.959823, 90.039861 61.168785, 90.175111 61.377641, 90.31196799999999 61.586381, 90.450468 61.795005, 90.590519 62.003523, 90.73228 62.211919, 90.875794 62.420192, 91.021052 62.628342, 91.168053 62.836373, 91.316925 63.044271, 91.46771099999999 63.252035, 91.620355 63.459671, 91.774962 63.667171, 91.931617 63.874527, 92.090354 64.081738, 92.251107 64.28881199999999, 92.41405399999999 64.495733, 92.57924800000001 64.70249699999999, 92.746673 64.90910700000001, 92.916375 65.115562, 93.08848999999999 65.321848, 93.263075 65.527963, 93.44006400000001 65.733915, 93.619623 65.939689, 93.80184 66.145279, 93.98674699999999 66.350683, 94.17432599999999 66.555907, 94.364768 66.760932, 94.558148 66.96575300000001, 94.754446 67.170376, 94.953768 67.374792, 95.156263 67.578988, 95.362013 67.78295900000001, 95.570943 67.986716, 95.783299 68.190237, 95.999178 68.393513, 96.21861699999999 68.596546, 96.44166 68.799334, 96.66852299999999 69.001857, 96.899311 69.20410800000001, 97.134007 69.40609499999999, 97.37280199999999 69.6078, 97.615863 69.809208, 97.86329499999999 70.01031500000001, 98.115075 70.211127, 98.3715 70.41161700000001, 98.632707 70.611774, 98.898746 70.8116, 99.16975100000001 71.01108499999999, 99.445975 71.210206, 99.727576 71.408952, 100.014549 71.607331, 100.3072 71.80531499999999, 100.605734 72.002887, 100.91029 72.200039, 101.220943 72.396772, 101.538046 72.593052, 101.861807 72.78886199999999, 102.192311 72.98420400000001, 102.529819 73.17905500000001, 102.874644 73.373389, 103.227027 73.56718600000001, 103.587003 73.76045499999999, 103.955034 73.95315100000001, 104.331395 74.145251, 104.716286 74.33674499999999, 105.109927 74.527619, 105.512766 74.717831, 105.925117 74.90735599999999, 106.347138 75.096189, 106.779268 75.28429199999999, 107.221926 75.471627, 107.675456 75.65816700000001, 108.140041 75.843908, 108.616296 76.02878699999999, 109.104631 76.212771, 109.605357 76.395839, 110.118902 76.577957, 110.645857 76.759066, 111.186702 76.939125, 119.690177 75.29900600000001))"
                    }
                ]
            }
        ]
        
        isp_completeness_statuses = [event for event in isp_completeness_missing_left if len([value for value in event.eventTexts if value.name == "status" and value.value == "MISSING"]) > 0]

        assert len(isp_completeness_statuses) == 1

        # Check number of annotations generated
        annotations = self.session.query(Annotation).join(Source).filter(Source.name == "S2A_OPER_REP_PASS_E_CONTAINING_ALL_DATA_TO_BE_PROCESS.EOF").all()

        assert len(annotations) == 1

        # Check specific ISP completeness
        isp_completeness_1 = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL_%"),
                                                                                 Event.start == "2018-07-21T05:22:08.947423",
                                                                                 Event.stop == "2018-07-21T05:36:36.329510").all()

        assert len(isp_completeness_1) == 1

        assert isp_completeness_1[0].get_structured_values() == [
            {
                "type": "text",
                "value": "RECEIVED",
                "name": "status"
            },
            {
                "type": "double",
                "value": "16076.0",
                "name": "downlink_orbit"
            },
            {
                "type": "text",
                "value": "S2A",
                "name": "satellite"
            },
            {
                "type": "text",
                "value": "EDRS",
                "name": "reception_station"
            },
            {
                "type": "double",
                "value": "2.0",
                "name": "channel"
            },
            {
                "type": "double",
                "value": "20.0",
                "name": "vcid"
            },
            {
                "type": "text",
                "value": "NOMINAL",
                "name": "playback_type"
            },
            {
                "type": "double",
                "value": "16075.0",
                "name": "sensing_orbit"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((94.116896 59.067486, 93.93512200000001 58.821977, 93.755695 58.576244, 93.578564 58.330292, 93.403667 58.084127, 93.230935 57.837756, 93.060349 57.59118, 92.89186100000001 57.344402, 92.725425 57.097428, 92.560997 56.850262, 92.398534 56.602906, 92.23799200000001 56.355367, 92.079302 56.107649, 91.92244700000001 55.859755, 91.76739499999999 55.611688, 91.614107 55.36345, 91.462547 55.115045, 91.312679 54.866476, 91.164468 54.617746, 91.017866 54.368861, 90.872834 54.119824, 90.72936 53.870635, 90.587412 53.621297, 90.44696 53.371813, 90.307974 53.122186, 90.170424 52.872419, 90.03428099999999 52.622513, 89.899489 52.372476, 89.766051 52.122305, 89.63394 51.872003, 89.503131 51.621573, 89.373598 51.371016, 89.245318 51.120336, 89.11826499999999 50.869533, 88.992401 50.618613, 88.867707 50.367576, 88.744174 50.116423, 88.62178 49.865157, 88.50050400000001 49.613778, 88.380324 49.36229, 88.26122100000001 49.110692, 88.143169 48.858989, 88.026134 48.607184, 87.910118 48.355275, 87.795102 48.103265, 87.68107000000001 47.851154, 87.56800200000001 47.598946, 87.455883 47.34664, 87.344694 47.09424, 87.23440100000001 46.841747, 87.125001 46.589163, 87.016485 46.336487, 86.90883700000001 46.083722, 86.802041 45.830869, 86.696083 45.577928, 86.59094899999999 45.324902, 86.486616 45.071793, 86.383064 44.818601, 86.280295 44.565328, 86.17829500000001 44.311974, 86.077051 44.05854, 85.976551 43.805027, 85.876783 43.551438, 85.777733 43.297772, 85.67936899999999 43.044033, 85.581701 42.790219, 85.484717 42.536333, 85.388406 42.282374, 85.29275699999999 42.028344, 85.19776 41.774245, 85.103403 41.520076, 85.009666 41.265839, 84.91654 41.011536, 84.82402500000001 40.757167, 84.732111 40.502732, 84.640788 40.248232, 84.55004700000001 39.993669, 84.459878 39.739043, 84.37027 39.484355, 84.28120199999999 39.229606, 84.19268 38.974797, 84.104696 38.719929, 84.017242 38.465001, 83.930308 38.210015, 83.84388800000001 37.954972, 83.75797300000001 37.699872, 83.67254200000001 37.444717, 83.587598 37.189507, 83.503136 36.934243, 83.419149 36.678924, 83.33563100000001 36.423553, 83.252573 36.168129, 83.16996899999999 35.912653, 83.087807 35.657126, 83.006074 35.401549, 82.92477599999999 35.145922, 82.843906 34.890246, 82.76345600000001 34.634522, 82.683421 34.378749, 82.60379399999999 34.122928, 82.52457 33.867061, 82.445729 33.611148, 82.367278 33.35519, 82.28921200000001 33.099186, 82.21152600000001 32.843138, 82.134213 32.587045, 82.05726799999999 32.330909, 81.98068600000001 32.07473, 81.904455 31.818509, 81.82857 31.562246, 81.753033 31.305942, 81.67783799999999 31.049596, 81.60298 30.793211, 81.52845499999999 30.536785, 81.454257 30.28032, 81.38038 30.023817, 81.30681199999999 29.767275, 81.233557 29.510695, 81.160611 29.254078, 81.08797 28.997423, 81.015629 28.740732, 80.943584 28.484005, 80.87183 28.227242, 80.80035599999999 27.970445, 80.729163 27.713613, 80.658249 27.456746, 80.58761 27.199845, 80.51724299999999 26.942911, 80.447143 26.685944, 80.377306 26.428944, 80.307726 26.171913, 80.23839599999999 25.914849, 80.169319 25.657754, 80.10048999999999 25.400629, 80.03190600000001 25.143472, 79.96356400000001 24.886286, 79.89546 24.62907, 79.82759 24.371824, 79.759944 24.114549, 79.692526 23.857246, 79.625332 23.599915, 79.55835999999999 23.342556, 79.491606 23.08517, 79.425067 22.827756, 79.358739 22.570316, 79.29261700000001 22.312849, 79.226697 22.055357, 79.16098 21.797839, 79.095463 21.540296, 79.030142 21.282727, 78.96501499999999 21.025135, 78.90008 20.767518, 78.835331 20.509877, 78.770763 20.252213, 78.706377 19.994526, 78.642171 19.736817, 78.578143 19.479084, 78.51428900000001 19.22133, 78.45060700000001 18.963554, 78.38709299999999 18.705756, 78.32374299999999 18.447938, 78.26055599999999 18.190099, 78.19753 17.932239, 78.134664 17.67436, 78.07195400000001 17.41646, 78.009398 17.158541, 77.946994 16.900604, 77.884738 16.642647, 77.822626 16.384672, 77.760659 16.126679, 77.698835 15.868668, 77.63715000000001 15.61064, 77.575603 15.352594, 77.514191 15.094532, 77.452913 14.836453, 77.391763 14.578358, 77.330742 14.320248, 77.269848 14.062121, 77.20907800000001 13.803979, 77.14843 13.545823, 77.087903 13.287651, 77.027494 13.029466, 76.96720000000001 12.771266, 76.90701900000001 12.513052, 76.846951 12.254825, 76.786993 11.996585, 76.727142 11.738332, 76.66739800000001 11.480067, 76.607758 11.221789, 76.548219 10.9635, 76.48878000000001 10.705198, 76.42944 10.446886, 76.37019600000001 10.188562, 76.311046 9.930227, 76.25198899999999 9.671882, 76.193023 9.413527, 76.134146 9.155162000000001, 76.075355 8.896787, 76.01665 8.638403, 75.958029 8.38001, 73.40189700000001 8.945615999999999, 73.45882 9.204136999999999, 73.515772 9.462654000000001, 73.57275300000001 9.721166, 73.629758 9.979675, 73.686798 10.238179, 73.74387400000001 10.496677, 73.800988 10.75517, 73.858141 11.013657, 73.915335 11.272138, 73.972572 11.530613, 74.029843 11.789083, 74.087159 12.047545, 74.14452300000001 12.306001, 74.201936 12.564449, 74.259401 12.82289, 74.316919 13.081322, 74.37449100000001 13.339747, 74.432115 13.598164, 74.48979 13.856573, 74.547526 14.114973, 74.605324 14.373364, 74.663185 14.631746, 74.72111200000001 14.890118, 74.779107 15.14848, 74.83717 15.406832, 74.895293 15.665175, 74.95348799999999 15.923507, 75.011758 16.181828, 75.070105 16.440138, 75.12853200000001 16.698437, 75.187039 16.956724, 75.24562899999999 17.214999, 75.304294 17.473262, 75.363041 17.731514, 75.42187699999999 17.989752, 75.48080400000001 18.247978, 75.539824 18.506191, 75.598939 18.76439, 75.658152 19.022575, 75.71745900000001 19.280747, 75.776856 19.538905, 75.83635700000001 19.797048, 75.89596299999999 20.055177, 75.95567699999999 20.313291, 76.015502 20.571389, 76.075439 20.829472, 76.13549 21.087539, 76.195644 21.345591, 76.255915 21.603626, 76.31630699999999 21.861645, 76.376823 22.119647, 76.437466 22.377632, 76.498237 22.6356, 76.55914 22.89355, 76.620167 23.151482, 76.68132199999999 23.409396, 76.742615 23.667292, 76.80404900000001 23.92517, 76.865627 24.183028, 76.927351 24.440867, 76.989225 24.698686, 77.051249 24.956486, 77.11341 25.214266, 77.17572699999999 25.472026, 77.23820499999999 25.729765, 77.30084600000001 25.987484, 77.363652 26.245181, 77.426627 26.502856, 77.489774 26.76051, 77.55308100000001 27.018142, 77.616559 27.275752, 77.680218 27.533339, 77.74406 27.790904, 77.808089 28.048445, 77.87230700000001 28.305963, 77.93671999999999 28.563456, 78.001323 28.820926, 78.066109 29.078373, 78.13109900000001 29.335794, 78.19629399999999 29.593191, 78.2617 29.850562, 78.32732 30.107907, 78.393156 30.365227, 78.459214 30.62252, 78.525475 30.879787, 78.591962 31.137028, 78.65868 31.394242, 78.725633 31.651428, 78.79282600000001 31.908586, 78.860263 32.165716, 78.927948 32.422818, 78.995873 32.679891, 79.06404000000001 32.936936, 79.13246700000001 33.193951, 79.20115800000001 33.450936, 79.270117 33.707891, 79.33935 33.964816, 79.40886 34.221709, 79.478652 34.478572, 79.548705 34.735404, 79.619049 34.992204, 79.689689 35.248972, 79.760631 35.505707, 79.831878 35.762409, 79.903437 36.019078, 79.975312 36.275713, 80.04749099999999 36.532314, 80.11998699999999 36.788881, 80.192814 37.045414, 80.26598 37.301911, 80.339489 37.558372, 80.413347 37.814797, 80.48756 38.071185, 80.562127 38.327536, 80.637038 38.583852, 80.712322 38.840129, 80.78798500000001 39.096368, 80.864034 39.352569, 80.94047500000001 39.60873, 81.017314 39.864851, 81.09456 40.120932, 81.172192 40.376974, 81.250238 40.632975, 81.32871 40.888934, 81.407616 41.144851, 81.486963 41.400726, 81.566759 41.656557, 81.647012 41.912345, 81.727715 42.16809, 81.80887199999999 42.423791, 81.89050899999999 42.679446, 81.972635 42.935056, 82.05525799999999 43.190619, 82.13838800000001 43.446136, 82.22203399999999 43.701605, 82.306203 43.957025, 82.390872 44.212399, 82.476083 44.467724, 82.561847 44.722999, 82.648173 44.978223, 82.735073 45.233395, 82.82255600000001 45.488516, 82.910633 45.743584, 82.999291 45.9986, 83.08855 46.253563, 83.178436 46.508471, 83.26896000000001 46.763324, 83.360135 47.01812, 83.451971 47.272859, 83.544483 47.52754, 83.63767300000001 47.782163, 83.731532 48.036729, 83.826104 48.291234, 83.921403 48.545678, 84.017442 48.80006, 84.11423600000001 49.054379, 84.2118 49.308634, 84.310148 49.562824, 84.409262 49.816951, 84.509182 50.071011, 84.609933 50.325004, 84.71153099999999 50.578928, 84.81399399999999 50.832781, 84.917338 51.086564, 85.021581 51.340274, 85.126724 51.593913, 85.232775 51.847479, 85.33978 52.100969, 85.447759 52.354382, 85.55673299999999 52.607717, 85.666721 52.860973, 85.777745 53.114147, 85.889827 53.36724, 86.00294 53.620252, 86.11715599999999 53.87318, 86.232497 54.126021, 86.348989 54.378774, 86.46665400000001 54.631436, 86.58552 54.884008, 86.705612 55.136487, 86.826928 55.388873, 86.94950300000001 55.641165, 87.073387 55.893359, 87.19860799999999 56.145453, 87.325198 56.397444, 87.453187 56.649331, 87.582607 56.901113, 87.713481 57.152787, 87.84580800000001 57.404355, 87.97966700000001 57.65581, 88.115093 57.90715, 88.25212399999999 58.158374, 88.39079700000001 58.409477, 88.531153 58.660459, 88.67323 58.911315, 88.817026 59.162049, 88.962616 59.412653, 89.110055 59.663125, 89.25939099999999 59.91346, 94.116896 59.067486))"
                    }
                ]
            }
        ]

        isp_completeness_2 = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL_%"),
                                                                                 Event.start == "2018-07-21T05:37:14.362833",
                                                                                 Event.stop == "2018-07-21T05:40:35.417601").all()

        assert len(isp_completeness_2) == 1

        # Check PLANNED_PLAYBACK_COMPLETENESS_CHANNEL events
        playback_completeness_events = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_PLAYBACK_COMPLETENESS_CHANNEL%")).all()

        assert len(playback_completeness_events) == 3

        # Check specific playback completeness
        playback_completeness_1 = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_PLAYBACK_COMPLETENESS_CHANNEL_2"),
                                                                                 Event.start == "2018-07-21T07:08:01.391740",
                                                                                 Event.stop == "2018-07-21T07:25:03.350719").all()

        assert len(playback_completeness_1) == 1

        assert playback_completeness_1[0].get_structured_values() == [
            {
                "type": "text",
                "value": "RECEIVED",
                "name": "status"
            },
            {
                "type": "double",
                "value": "16076.0",
                "name": "downlink_orbit"
            },
            {
                "type": "text",
                "value": "S2A",
                "name": "satellite"
            },
            {
                "type": "text",
                "value": "EDRS",
                "name": "reception_station"
            },
            {
                "type": "double",
                "value": "2.0",
                "name": "channel"
            },
            {
                "type": "double",
                "value": "20.0",
                "name": "vcid"
            },
            {
                "type": "text",
                "value": "NOMINAL",
                "name": "playback_type"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((59.814781 41.210405, 59.705287 40.910757, 59.596632 40.611016, 59.488799 40.311186, 59.381774 40.011268, 59.275541 39.711262, 59.170086 39.41117, 59.065395 39.110994, 58.961453 38.810734, 58.858247 38.510393, 58.755763 38.20997, 58.653989 37.909469, 58.552911 37.608888, 58.452516 37.308231, 58.352794 37.007498, 58.25373 36.70669, 58.155315 36.405808, 58.057535 36.104853, 57.960381 35.803827, 57.86384 35.502731, 57.767902 35.201565, 57.672557 34.90033, 57.577794 34.599028, 57.483602 34.297659, 57.389973 33.996225, 57.296895 33.694727, 57.20436 33.393164, 57.112357 33.091539, 57.020879 32.789852, 56.929915 32.488105, 56.839457 32.186297, 56.749497 31.88443, 56.660025 31.582505, 56.571033 31.280522, 56.482514 30.978483, 56.394458 30.676387, 56.306859 30.374237, 56.219708 30.072033, 56.132997 29.769775, 56.04672 29.467465, 55.960869 29.165102, 55.875436 28.862689, 55.790415 28.560225, 55.705799 28.257712, 55.62158 27.95515, 55.537753 27.652539, 55.45431 27.349881, 55.371244 27.047177, 55.288549 26.744426, 55.206219 26.44163, 55.124249 26.138789, 55.042631 25.835905, 54.961361 25.532977, 54.880431 25.230006, 54.799838 24.926993, 54.719574 24.623939, 54.639634 24.320844, 54.560013 24.01771, 54.480705 23.714535, 54.401705 23.411322, 54.323008 23.10807, 54.244608 22.804781, 54.166501 22.501455, 54.08868 22.198093, 54.011143 21.894695, 53.933883 21.591262, 53.856896 21.287794, 53.780176 20.984291, 53.70372 20.680756, 53.627523 20.377188, 53.55158 20.073587, 53.475887 19.769955, 53.40044 19.466291, 53.325233 19.162597, 53.250263 18.858873, 53.175526 18.555119, 53.101017 18.251337, 53.026732 17.947526, 52.952668 17.643687, 52.87882 17.339821, 52.805183 17.035928, 52.731756 16.732008, 52.658532 16.428064, 52.585509 16.124093, 52.512683 15.820098, 52.440051 15.516079, 52.367607 15.212037, 52.29535 14.907971, 52.223275 14.603883, 52.151378 14.299772, 52.079656 13.99564, 52.008107 13.691487, 51.936725 13.387313, 51.865508 13.08312, 51.794453 12.778906, 51.723556 12.474674, 51.652813 12.170423, 51.582223 11.866153, 51.51178 11.561867, 51.441483 11.257563, 51.371327 10.953242, 51.301311 10.648905, 51.23143 10.344553, 51.161682 10.040185, 51.092063 9.735803000000001, 51.022571 9.431406000000001, 50.953203 9.126996, 50.883955 8.822571999999999, 50.814825 8.518136, 50.745809 8.213687, 50.676906 7.909226, 50.608111 7.604754, 50.539422 7.300271, 50.470837 6.995778, 50.402351 6.691274, 50.333964 6.386761, 50.265671 6.082239, 50.19747 5.777708, 50.129358 5.473169, 50.061333 5.168622, 49.993392 4.864068, 49.925531 4.559507, 49.85775 4.254939, 49.790043 3.950366, 49.72241 3.645788, 49.654847 3.341204, 49.587352 3.036616, 49.519922 2.732023, 49.452555 2.427427, 49.385247 2.122828, 49.317997 1.818226, 49.250801 1.513621, 49.183658 1.209015, 49.116564 0.904407, 49.049517 0.5997980000000001, 48.982514 0.295189, 48.915554 -0.009421000000000001, 48.848632 -0.31403, 48.781748 -0.618639, 48.714898 -0.923246, 48.648079 -1.227852, 48.58129 -1.532456, 48.514527 -1.837058, 48.447789 -2.141656, 48.381072 -2.446252, 48.314374 -2.750843, 48.247693 -3.055431, 48.181027 -3.360014, 48.114371 -3.664591, 48.047725 -3.969164, 47.981085 -4.27373, 47.91445 -4.57829, 47.847816 -4.882844, 47.781182 -5.18739, 47.714545 -5.491929, 47.647901 -5.79646, 47.581249 -6.100982, 47.514585 -6.405496, 47.447908 -6.71, 47.381215 -7.014495, 47.314503 -7.31898, 47.24777 -7.623454, 47.181012 -7.927917, 47.114228 -8.232369, 47.047415 -8.536809, 46.980571 -8.841237, 46.913691 -9.145652, 46.846775 -9.450055000000001, 46.77982 -9.754443999999999, 46.712822 -10.058819, 46.645779 -10.36318, 46.578688 -10.667527, 46.511547 -10.971858, 46.444353 -11.276174, 46.377103 -11.580474, 46.309795 -11.884758, 46.242425 -12.189025, 46.174992 -12.493275, 46.107491 -12.797508, 46.039921 -13.101722, 45.972279 -13.405919, 45.904561 -13.710096, 45.836765 -14.014255, 45.768887 -14.318394, 45.700926 -14.622513, 45.632878 -14.926611, 45.564739 -15.230689, 45.496508 -15.534746, 45.428181 -15.838781, 45.359755 -16.142794, 45.291226 -16.446785, 45.222593 -16.750752, 45.15385 -17.054697, 45.084997 -17.358618, 45.016029 -17.662515, 44.946942 -17.966388, 44.877735 -18.270236, 44.808403 -18.574058, 44.738943 -18.877855, 44.669352 -19.181626, 41.983236 -18.60262, 42.057859 -18.299327, 42.132258 -17.996, 42.206438 -17.692637, 42.280403 -17.38924, 42.354156 -17.085808, 42.427701 -16.782344, 42.501042 -16.478846, 42.574184 -16.175316, 42.647129 -15.871755, 42.719882 -15.568162, 42.792445 -15.264538, 42.864824 -14.960884, 42.937021 -14.657199, 43.00904 -14.353486, 43.080884 -14.049744, 43.152557 -13.745973, 43.224063 -13.442174, 43.295404 -13.138348, 43.366584 -12.834495, 43.437607 -12.530616, 43.508475 -12.226711, 43.579192 -11.92278, 43.649762 -11.618824, 43.720187 -11.314844, 43.79047 -11.01084, 43.860615 -10.706812, 43.930625 -10.402761, 44.000503 -10.098688, 44.070252 -9.794592, 44.139874 -9.490475, 44.209374 -9.186336000000001, 44.278754 -8.882177, 44.348016 -8.577997, 44.417164 -8.273797999999999, 44.486202 -7.969579, 44.55513 -7.665342, 44.623954 -7.361086, 44.692674 -7.056812, 44.761295 -6.75252, 44.829819 -6.448211, 44.898248 -6.143886, 44.966587 -5.839545, 45.034836 -5.535188, 45.102999 -5.230815, 45.17108 -4.926428, 45.239079 -4.622026, 45.307001 -4.317611, 45.374848 -4.013182, 45.442622 -3.70874, 45.510326 -3.404285, 45.577962 -3.099818, 45.645535 -2.795339, 45.713045 -2.49085, 45.780496 -2.186349, 45.84789 -1.881838, 45.91523 -1.577317, 45.982518 -1.272786, 46.049757 -0.968247, 46.11695 -0.663699, 46.184099 -0.359142, 46.251206 -0.054578, 46.318275 0.249993, 46.385308 0.554571, 46.452307 0.859156, 46.519275 1.163747, 46.586214 1.468343, 46.653127 1.772945, 46.720016 2.077551, 46.786885 2.382161, 46.853735 2.686775, 46.920569 2.991393, 46.987389 3.296014, 47.054199 3.600637, 47.121 3.905263, 47.187795 4.20989, 47.254587 4.514518, 47.321378 4.819147, 47.388171 5.123777, 47.454967 5.428407, 47.521771 5.733036, 47.588584 6.037664, 47.655409 6.342292, 47.722249 6.646917, 47.789105 6.95154, 47.855981 7.256161, 47.92288 7.560779, 47.989803 7.865393, 48.056753 8.170004, 48.123733 8.47461, 48.190746 8.779211999999999, 48.257794 9.083809, 48.324881 9.388400000000001, 48.392007 9.692985, 48.459177 9.997564000000001, 48.526393 10.302136, 48.593657 10.606701, 48.660972 10.911259, 48.728342 11.215808, 48.795768 11.520349, 48.863254 11.824881, 48.930801 12.129404, 48.998412 12.433917, 49.066092 12.73842, 49.133842 13.042913, 49.201665 13.347394, 49.269565 13.651864, 49.337545 13.956323, 49.405606 14.260769, 49.473753 14.565202, 49.541987 14.869623, 49.610313 15.17403, 49.678733 15.478423, 49.747251 15.782802, 49.815868 16.087166, 49.884589 16.391515, 49.953416 16.695848, 50.022353 17.000165, 50.091403 17.304466, 50.160569 17.60875, 50.229854 17.913017, 50.299262 18.217266, 50.368796 18.521497, 50.438459 18.82571, 50.508255 19.129903, 50.578186 19.434077, 50.648258 19.738231, 50.718472 20.042365, 50.788833 20.346479, 50.859345 20.650571, 50.93001 20.954641, 51.000833 21.25869, 51.071817 21.562716, 51.142967 21.86672, 51.214285 22.1707, 51.285776 22.474657, 51.357444 22.778589, 51.429292 23.082497, 51.501325 23.386379, 51.573548 23.690236, 51.645963 23.994068, 51.718575 24.297873, 51.791389 24.601651, 51.864408 24.905402, 51.937638 25.209125, 52.011082 25.51282, 52.084746 25.816487, 52.158633 26.120124, 52.232749 26.423732, 52.307097 26.72731, 52.381684 27.030857, 52.456514 27.334374, 52.531591 27.637859, 52.60692 27.941312, 52.682505 28.244733, 52.758353 28.548121, 52.834469 28.851476, 52.910859 29.154797, 52.987529 29.458084, 53.064483 29.761336, 53.141728 30.064553, 53.219269 30.367734, 53.297112 30.670879, 53.375263 30.973987, 53.453728 31.277058, 53.532514 31.580091, 53.611626 31.883085, 53.691071 32.186041, 53.770856 32.488957, 53.850987 32.791833, 53.931471 33.094669, 54.012314 33.397464, 54.093525 33.700217, 54.175109 34.002928, 54.257075 34.305597, 54.33943 34.608222, 54.422182 34.910803, 54.505337 35.213339, 54.588905 35.515831, 54.672892 35.818277, 54.757308 36.120677, 54.842161 36.423029, 54.92746 36.725334, 55.013212 37.027591, 55.099428 37.329799, 55.186116 37.631958, 55.273285 37.934067, 55.360946 38.236124, 55.449107 38.53813, 55.537779 38.840084, 55.626972 39.141985, 55.716696 39.443832, 55.806962 39.745625, 55.897782 40.047362, 55.989165 40.349044, 56.081123 40.650669, 56.173669 40.952236, 56.266813 41.253745, 56.360568 41.555195, 56.454947 41.856586, 59.814781 41.210405))"
                    }
                ]
            }
        ]

        # Check specific playback completeness
        playback_completeness_2 = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_PLAYBACK_COMPLETENESS_CHANNEL_%"),
                                                                                 Event.start == "2018-07-21T07:25:26.346331",
                                                                                 Event.stop == "2018-07-21T07:25:28.346331").all()

        assert len(playback_completeness_2) == 1

        assert playback_completeness_2[0].get_structured_values() == [
            {
                "type": "text",
                "value": "RECEIVED",
                "name": "status"
            },
            {
                "type": "double",
                "value": "16076.0",
                "name": "downlink_orbit"
            },
            {
                "type": "text",
                "value": "S2A",
                "name": "satellite"
            },
            {
                "type": "text",
                "value": "EDRS",
                "name": "reception_station"
            },
            {
                "type": "double",
                "value": "2.0",
                "name": "channel"
            },
            {
                "type": "double",
                "value": "2.0",
                "name": "vcid"
            },
            {
                "type": "text",
                "value": "SAD",
                "name": "playback_type"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((44.328656 -20.659768, 41.616702 -20.078294, 41.616702 -20.078294, 44.328656 -20.659768))"
                    }
                ]
            }
        ]
        
    def test_insert_rep_pass_playback_rt_with_plan(self):

        filename = "S2A_NPPF_PLAYBACK_RT.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_nppf.ingestion_nppf", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2A_ORBPRE.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_orbpre.ingestion_orbpre", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2__SRA.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_slot_request_edrs.ingestion_slot_request_edrs", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]


        filename = "S2A_OPER_REP_PASS_E_PLAYBACK_RT.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_edrs_acquisition.ingestion_edrs_acquisition", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]
        assert returned_value[1]["status"] == eboa_engine.exit_codes["OK"]["status"]

        # Check sources
        sources = self.session.query(Source).all()

        assert len(sources) == 10
        
        source = self.session.query(Source).filter(Source.validity_start == "2018-07-20T17:33:12.859268",
                                                   Source.validity_stop == "2018-07-21T07:37:55.121772",
                                                   Source.name == "S2A_OPER_REP_PASS_E_PLAYBACK_RT.EOF",
                                                   Source.processor == "ingestion_edrs_acquisition.py").all()

        assert len(source) == 2

        source = self.session.query(Source).filter(Source.validity_start == "2018-07-21T05:22:08.947423",
                                                   Source.validity_stop == "2018-07-21T05:40:35.417601",
                                                   Source.name == "S2A_OPER_REP_PASS_E_PLAYBACK_RT.EOF",
                                                   Source.processor == "isp_planning_completeness_ingestion_edrs_acquisition.py").all()

        assert len(source) == 1

        # Check number of events generated
        events = self.session.query(Event).join(Source).filter(Source.name == "S2A_OPER_REP_PASS_E_PLAYBACK_RT.EOF").all()

        assert len(events) == 17

        # Check PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL events
        isp_completeness_events = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL%")).all()

        assert len(isp_completeness_events) == 5

        # Check definite ISP completeness
        isp_completeness_missing_left = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL_%"),
                                                                                 Event.start == "2018-07-21T05:16:58.773036",
                                                                                 Event.stop == "2018-07-21T05:22:08.947423").all()

        assert len(isp_completeness_missing_left) == 1

        assert isp_completeness_missing_left[0].get_structured_values() == [
            {
                "type": "text",
                "value": "MPMSNOBS",
                "name": "start_request"
            },
            {
                "type": "text",
                "value": "MPMSIMID",
                "name": "stop_request"
            },
            {
                "type": "double",
                "value": "16075.0",
                "name": "start_orbit"
            },
            {
                "type": "double",
                "value": "100.3083",
                "name": "start_angle"
            },
            {
                "type": "double",
                "value": "16075.0",
                "name": "stop_orbit"
            },
            {
                "type": "double",
                "value": "171.1847",
                "name": "stop_angle"
            },
            {
                "type": "text",
                "value": "S2A",
                "name": "satellite"
            },
            {
                "type": "text",
                "value": "NOMINAL",
                "name": "record_type"
            },
            {
                "type": "text",
                "value": "NOMINAL",
                "name": "imaging_mode"
            },
            {
                "type": "object",
                "values": [
                    {
                        "type": "double",
                        "value": "0.0",
                        "name": "start_scn_dup"
                    }
                ],
                "name": "parameters"
            },
            {
                "type": "text",
                "value": "TIME_CORRECTED",
                "name": "status_correction"
            },
            {
                "type": "double",
                "value": "-5.365036",
                "name": "delta_start"
            },
            {
                "type": "double",
                "value": "-5.12251",
                "name": "delta_stop"
            },
            {
                "type": "text",
                "value": "MISSING",
                "name": "status"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((119.690177 75.29900600000001, 119.108056 75.137455, 118.53799 74.97452, 117.979688 74.810244, 117.432787 74.644687, 116.897014 74.47788799999999, 116.372162 74.309872, 115.85796 74.14067799999999, 115.354011 73.97036799999999, 114.860172 73.798956, 114.3762 73.62647200000001, 113.901807 73.452958, 113.436685 73.278457, 112.9807 73.102981, 112.533617 72.92655999999999, 112.095118 72.74923800000001, 111.665027 72.571037, 111.243173 72.39197299999999, 110.829342 72.21207200000001, 110.423202 72.031384, 110.024685 71.849908, 109.633596 71.66766699999999, 109.249693 71.484692, 108.872766 71.301011, 108.502716 71.11662800000001, 108.139367 70.931566, 107.78245 70.74585999999999, 107.431873 70.559516, 107.087504 70.372547, 106.749168 70.18497499999999, 106.416627 69.996831, 106.089841 69.80811199999999, 105.768666 69.618835, 105.452899 69.429025, 105.142412 69.238697, 104.837134 69.047853, 104.536934 68.85650800000001, 104.241583 68.664694, 103.951057 68.47240600000001, 103.665251 68.27965500000001, 103.384018 68.086459, 103.107198 67.892837, 102.834766 67.698787, 102.56662 67.50432000000001, 102.302583 67.30945699999999, 102.042593 67.114204, 101.786593 66.918564, 101.534487 66.72254700000001, 101.286081 66.526178, 101.041395 66.32944999999999, 100.800344 66.13237100000001, 100.5628 65.934957, 100.328664 65.737218, 100.09792 65.539152, 99.870492 65.340767, 99.646226 65.142084, 99.425107 64.943099, 99.207088 64.74381700000001, 98.992086 64.544247, 98.779963 64.34440499999999, 98.57074299999999 64.14428599999999, 98.36435899999999 63.943895, 98.160701 63.743246, 97.959715 63.542343, 97.76138899999999 63.341187, 97.565665 63.139782, 97.372404 62.938146, 97.181629 62.736273, 96.993296 62.534166, 96.807329 62.331835, 96.623639 62.12929, 96.442244 61.926526, 96.263096 61.723547, 96.08609199999999 61.520367, 95.911214 61.316985, 95.73845 61.113401, 95.56775500000001 60.90962, 95.399007 60.705656, 95.232249 60.501502, 95.067442 60.297162, 94.90451400000001 60.092644, 94.74341099999999 59.887954, 94.584148 59.683088, 94.426688 59.478049, 94.270933 59.272849, 94.116896 59.067486, 89.25939099999999 59.91346, 89.38592199999999 60.122933, 89.513845 60.332306, 89.643119 60.541585, 89.773871 60.750758, 89.906133 60.959823, 90.039861 61.168785, 90.175111 61.377641, 90.31196799999999 61.586381, 90.450468 61.795005, 90.590519 62.003523, 90.73228 62.211919, 90.875794 62.420192, 91.021052 62.628342, 91.168053 62.836373, 91.316925 63.044271, 91.46771099999999 63.252035, 91.620355 63.459671, 91.774962 63.667171, 91.931617 63.874527, 92.090354 64.081738, 92.251107 64.28881199999999, 92.41405399999999 64.495733, 92.57924800000001 64.70249699999999, 92.746673 64.90910700000001, 92.916375 65.115562, 93.08848999999999 65.321848, 93.263075 65.527963, 93.44006400000001 65.733915, 93.619623 65.939689, 93.80184 66.145279, 93.98674699999999 66.350683, 94.17432599999999 66.555907, 94.364768 66.760932, 94.558148 66.96575300000001, 94.754446 67.170376, 94.953768 67.374792, 95.156263 67.578988, 95.362013 67.78295900000001, 95.570943 67.986716, 95.783299 68.190237, 95.999178 68.393513, 96.21861699999999 68.596546, 96.44166 68.799334, 96.66852299999999 69.001857, 96.899311 69.20410800000001, 97.134007 69.40609499999999, 97.37280199999999 69.6078, 97.615863 69.809208, 97.86329499999999 70.01031500000001, 98.115075 70.211127, 98.3715 70.41161700000001, 98.632707 70.611774, 98.898746 70.8116, 99.16975100000001 71.01108499999999, 99.445975 71.210206, 99.727576 71.408952, 100.014549 71.607331, 100.3072 71.80531499999999, 100.605734 72.002887, 100.91029 72.200039, 101.220943 72.396772, 101.538046 72.593052, 101.861807 72.78886199999999, 102.192311 72.98420400000001, 102.529819 73.17905500000001, 102.874644 73.373389, 103.227027 73.56718600000001, 103.587003 73.76045499999999, 103.955034 73.95315100000001, 104.331395 74.145251, 104.716286 74.33674499999999, 105.109927 74.527619, 105.512766 74.717831, 105.925117 74.90735599999999, 106.347138 75.096189, 106.779268 75.28429199999999, 107.221926 75.471627, 107.675456 75.65816700000001, 108.140041 75.843908, 108.616296 76.02878699999999, 109.104631 76.212771, 109.605357 76.395839, 110.118902 76.577957, 110.645857 76.759066, 111.186702 76.939125, 119.690177 75.29900600000001))"
                    }
                ]
            }
        ]
        
        isp_completeness_statuses = [event for event in isp_completeness_missing_left if len([value for value in event.eventTexts if value.name == "status" and value.value == "MISSING"]) > 0]

        assert len(isp_completeness_statuses) == 1

        # Check number of annotations generated
        annotations = self.session.query(Annotation).join(Source).filter(Source.name == "S2A_OPER_REP_PASS_E_PLAYBACK_RT.EOF").all()

        assert len(annotations) == 1

        # Check specific ISP completeness
        isp_completeness_1 = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL_%"),
                                                                                 Event.start == "2018-07-21T05:22:08.947423",
                                                                                 Event.stop == "2018-07-21T05:36:36.329510").all()

        assert len(isp_completeness_1) == 1

        assert isp_completeness_1[0].get_structured_values() == [
            {
                "type": "text",
                "value": "RECEIVED",
                "name": "status"
            },
            {
                "type": "double",
                "value": "16076.0",
                "name": "downlink_orbit"
            },
            {
                "type": "text",
                "value": "S2A",
                "name": "satellite"
            },
            {
                "type": "text",
                "value": "EDRS",
                "name": "reception_station"
            },
            {
                "type": "double",
                "value": "2.0",
                "name": "channel"
            },
            {
                "type": "double",
                "value": "22.0",
                "name": "vcid"
            },
            {
                "type": "text",
                "value": "RT",
                "name": "playback_type"
            },
            {
                "type": "double",
                "value": "16075.0",
                "name": "sensing_orbit"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((94.116896 59.067486, 93.93512200000001 58.821977, 93.755695 58.576244, 93.578564 58.330292, 93.403667 58.084127, 93.230935 57.837756, 93.060349 57.59118, 92.89186100000001 57.344402, 92.725425 57.097428, 92.560997 56.850262, 92.398534 56.602906, 92.23799200000001 56.355367, 92.079302 56.107649, 91.92244700000001 55.859755, 91.76739499999999 55.611688, 91.614107 55.36345, 91.462547 55.115045, 91.312679 54.866476, 91.164468 54.617746, 91.017866 54.368861, 90.872834 54.119824, 90.72936 53.870635, 90.587412 53.621297, 90.44696 53.371813, 90.307974 53.122186, 90.170424 52.872419, 90.03428099999999 52.622513, 89.899489 52.372476, 89.766051 52.122305, 89.63394 51.872003, 89.503131 51.621573, 89.373598 51.371016, 89.245318 51.120336, 89.11826499999999 50.869533, 88.992401 50.618613, 88.867707 50.367576, 88.744174 50.116423, 88.62178 49.865157, 88.50050400000001 49.613778, 88.380324 49.36229, 88.26122100000001 49.110692, 88.143169 48.858989, 88.026134 48.607184, 87.910118 48.355275, 87.795102 48.103265, 87.68107000000001 47.851154, 87.56800200000001 47.598946, 87.455883 47.34664, 87.344694 47.09424, 87.23440100000001 46.841747, 87.125001 46.589163, 87.016485 46.336487, 86.90883700000001 46.083722, 86.802041 45.830869, 86.696083 45.577928, 86.59094899999999 45.324902, 86.486616 45.071793, 86.383064 44.818601, 86.280295 44.565328, 86.17829500000001 44.311974, 86.077051 44.05854, 85.976551 43.805027, 85.876783 43.551438, 85.777733 43.297772, 85.67936899999999 43.044033, 85.581701 42.790219, 85.484717 42.536333, 85.388406 42.282374, 85.29275699999999 42.028344, 85.19776 41.774245, 85.103403 41.520076, 85.009666 41.265839, 84.91654 41.011536, 84.82402500000001 40.757167, 84.732111 40.502732, 84.640788 40.248232, 84.55004700000001 39.993669, 84.459878 39.739043, 84.37027 39.484355, 84.28120199999999 39.229606, 84.19268 38.974797, 84.104696 38.719929, 84.017242 38.465001, 83.930308 38.210015, 83.84388800000001 37.954972, 83.75797300000001 37.699872, 83.67254200000001 37.444717, 83.587598 37.189507, 83.503136 36.934243, 83.419149 36.678924, 83.33563100000001 36.423553, 83.252573 36.168129, 83.16996899999999 35.912653, 83.087807 35.657126, 83.006074 35.401549, 82.92477599999999 35.145922, 82.843906 34.890246, 82.76345600000001 34.634522, 82.683421 34.378749, 82.60379399999999 34.122928, 82.52457 33.867061, 82.445729 33.611148, 82.367278 33.35519, 82.28921200000001 33.099186, 82.21152600000001 32.843138, 82.134213 32.587045, 82.05726799999999 32.330909, 81.98068600000001 32.07473, 81.904455 31.818509, 81.82857 31.562246, 81.753033 31.305942, 81.67783799999999 31.049596, 81.60298 30.793211, 81.52845499999999 30.536785, 81.454257 30.28032, 81.38038 30.023817, 81.30681199999999 29.767275, 81.233557 29.510695, 81.160611 29.254078, 81.08797 28.997423, 81.015629 28.740732, 80.943584 28.484005, 80.87183 28.227242, 80.80035599999999 27.970445, 80.729163 27.713613, 80.658249 27.456746, 80.58761 27.199845, 80.51724299999999 26.942911, 80.447143 26.685944, 80.377306 26.428944, 80.307726 26.171913, 80.23839599999999 25.914849, 80.169319 25.657754, 80.10048999999999 25.400629, 80.03190600000001 25.143472, 79.96356400000001 24.886286, 79.89546 24.62907, 79.82759 24.371824, 79.759944 24.114549, 79.692526 23.857246, 79.625332 23.599915, 79.55835999999999 23.342556, 79.491606 23.08517, 79.425067 22.827756, 79.358739 22.570316, 79.29261700000001 22.312849, 79.226697 22.055357, 79.16098 21.797839, 79.095463 21.540296, 79.030142 21.282727, 78.96501499999999 21.025135, 78.90008 20.767518, 78.835331 20.509877, 78.770763 20.252213, 78.706377 19.994526, 78.642171 19.736817, 78.578143 19.479084, 78.51428900000001 19.22133, 78.45060700000001 18.963554, 78.38709299999999 18.705756, 78.32374299999999 18.447938, 78.26055599999999 18.190099, 78.19753 17.932239, 78.134664 17.67436, 78.07195400000001 17.41646, 78.009398 17.158541, 77.946994 16.900604, 77.884738 16.642647, 77.822626 16.384672, 77.760659 16.126679, 77.698835 15.868668, 77.63715000000001 15.61064, 77.575603 15.352594, 77.514191 15.094532, 77.452913 14.836453, 77.391763 14.578358, 77.330742 14.320248, 77.269848 14.062121, 77.20907800000001 13.803979, 77.14843 13.545823, 77.087903 13.287651, 77.027494 13.029466, 76.96720000000001 12.771266, 76.90701900000001 12.513052, 76.846951 12.254825, 76.786993 11.996585, 76.727142 11.738332, 76.66739800000001 11.480067, 76.607758 11.221789, 76.548219 10.9635, 76.48878000000001 10.705198, 76.42944 10.446886, 76.37019600000001 10.188562, 76.311046 9.930227, 76.25198899999999 9.671882, 76.193023 9.413527, 76.134146 9.155162000000001, 76.075355 8.896787, 76.01665 8.638403, 75.958029 8.38001, 73.40189700000001 8.945615999999999, 73.45882 9.204136999999999, 73.515772 9.462654000000001, 73.57275300000001 9.721166, 73.629758 9.979675, 73.686798 10.238179, 73.74387400000001 10.496677, 73.800988 10.75517, 73.858141 11.013657, 73.915335 11.272138, 73.972572 11.530613, 74.029843 11.789083, 74.087159 12.047545, 74.14452300000001 12.306001, 74.201936 12.564449, 74.259401 12.82289, 74.316919 13.081322, 74.37449100000001 13.339747, 74.432115 13.598164, 74.48979 13.856573, 74.547526 14.114973, 74.605324 14.373364, 74.663185 14.631746, 74.72111200000001 14.890118, 74.779107 15.14848, 74.83717 15.406832, 74.895293 15.665175, 74.95348799999999 15.923507, 75.011758 16.181828, 75.070105 16.440138, 75.12853200000001 16.698437, 75.187039 16.956724, 75.24562899999999 17.214999, 75.304294 17.473262, 75.363041 17.731514, 75.42187699999999 17.989752, 75.48080400000001 18.247978, 75.539824 18.506191, 75.598939 18.76439, 75.658152 19.022575, 75.71745900000001 19.280747, 75.776856 19.538905, 75.83635700000001 19.797048, 75.89596299999999 20.055177, 75.95567699999999 20.313291, 76.015502 20.571389, 76.075439 20.829472, 76.13549 21.087539, 76.195644 21.345591, 76.255915 21.603626, 76.31630699999999 21.861645, 76.376823 22.119647, 76.437466 22.377632, 76.498237 22.6356, 76.55914 22.89355, 76.620167 23.151482, 76.68132199999999 23.409396, 76.742615 23.667292, 76.80404900000001 23.92517, 76.865627 24.183028, 76.927351 24.440867, 76.989225 24.698686, 77.051249 24.956486, 77.11341 25.214266, 77.17572699999999 25.472026, 77.23820499999999 25.729765, 77.30084600000001 25.987484, 77.363652 26.245181, 77.426627 26.502856, 77.489774 26.76051, 77.55308100000001 27.018142, 77.616559 27.275752, 77.680218 27.533339, 77.74406 27.790904, 77.808089 28.048445, 77.87230700000001 28.305963, 77.93671999999999 28.563456, 78.001323 28.820926, 78.066109 29.078373, 78.13109900000001 29.335794, 78.19629399999999 29.593191, 78.2617 29.850562, 78.32732 30.107907, 78.393156 30.365227, 78.459214 30.62252, 78.525475 30.879787, 78.591962 31.137028, 78.65868 31.394242, 78.725633 31.651428, 78.79282600000001 31.908586, 78.860263 32.165716, 78.927948 32.422818, 78.995873 32.679891, 79.06404000000001 32.936936, 79.13246700000001 33.193951, 79.20115800000001 33.450936, 79.270117 33.707891, 79.33935 33.964816, 79.40886 34.221709, 79.478652 34.478572, 79.548705 34.735404, 79.619049 34.992204, 79.689689 35.248972, 79.760631 35.505707, 79.831878 35.762409, 79.903437 36.019078, 79.975312 36.275713, 80.04749099999999 36.532314, 80.11998699999999 36.788881, 80.192814 37.045414, 80.26598 37.301911, 80.339489 37.558372, 80.413347 37.814797, 80.48756 38.071185, 80.562127 38.327536, 80.637038 38.583852, 80.712322 38.840129, 80.78798500000001 39.096368, 80.864034 39.352569, 80.94047500000001 39.60873, 81.017314 39.864851, 81.09456 40.120932, 81.172192 40.376974, 81.250238 40.632975, 81.32871 40.888934, 81.407616 41.144851, 81.486963 41.400726, 81.566759 41.656557, 81.647012 41.912345, 81.727715 42.16809, 81.80887199999999 42.423791, 81.89050899999999 42.679446, 81.972635 42.935056, 82.05525799999999 43.190619, 82.13838800000001 43.446136, 82.22203399999999 43.701605, 82.306203 43.957025, 82.390872 44.212399, 82.476083 44.467724, 82.561847 44.722999, 82.648173 44.978223, 82.735073 45.233395, 82.82255600000001 45.488516, 82.910633 45.743584, 82.999291 45.9986, 83.08855 46.253563, 83.178436 46.508471, 83.26896000000001 46.763324, 83.360135 47.01812, 83.451971 47.272859, 83.544483 47.52754, 83.63767300000001 47.782163, 83.731532 48.036729, 83.826104 48.291234, 83.921403 48.545678, 84.017442 48.80006, 84.11423600000001 49.054379, 84.2118 49.308634, 84.310148 49.562824, 84.409262 49.816951, 84.509182 50.071011, 84.609933 50.325004, 84.71153099999999 50.578928, 84.81399399999999 50.832781, 84.917338 51.086564, 85.021581 51.340274, 85.126724 51.593913, 85.232775 51.847479, 85.33978 52.100969, 85.447759 52.354382, 85.55673299999999 52.607717, 85.666721 52.860973, 85.777745 53.114147, 85.889827 53.36724, 86.00294 53.620252, 86.11715599999999 53.87318, 86.232497 54.126021, 86.348989 54.378774, 86.46665400000001 54.631436, 86.58552 54.884008, 86.705612 55.136487, 86.826928 55.388873, 86.94950300000001 55.641165, 87.073387 55.893359, 87.19860799999999 56.145453, 87.325198 56.397444, 87.453187 56.649331, 87.582607 56.901113, 87.713481 57.152787, 87.84580800000001 57.404355, 87.97966700000001 57.65581, 88.115093 57.90715, 88.25212399999999 58.158374, 88.39079700000001 58.409477, 88.531153 58.660459, 88.67323 58.911315, 88.817026 59.162049, 88.962616 59.412653, 89.110055 59.663125, 89.25939099999999 59.91346, 94.116896 59.067486))"
                    }
                ]
            }
        ]

        isp_completeness_2 = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_IMAGING_ISP_COMPLETENESS_CHANNEL_%"),
                                                                                 Event.start == "2018-07-21T05:37:14.362833",
                                                                                 Event.stop == "2018-07-21T05:40:35.417601").all()

        assert len(isp_completeness_2) == 1

        # Check PLANNED_PLAYBACK_COMPLETENESS_CHANNEL events
        playback_completeness_events = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_PLAYBACK_COMPLETENESS_CHANNEL%")).all()
        
        assert len(playback_completeness_events) == 3

        # Check specific playback completeness
        playback_completeness_1 = self.session.query(Event).join(Gauge).filter(Gauge.name.like("PLANNED_PLAYBACK_COMPLETENESS_CHANNEL_2"),
                                                                                 Event.start == "2018-07-21T07:08:01.391740",
                                                                                 Event.stop == "2018-07-21T07:25:03.350719").all()

        assert len(playback_completeness_1) == 1

        assert playback_completeness_1[0].get_structured_values() == [
            {
                "type": "text",
                "value": "RECEIVED",
                "name": "status"
            },
            {
                "type": "double",
                "value": "16076.0",
                "name": "downlink_orbit"
            },
            {
                "type": "text",
                "value": "S2A",
                "name": "satellite"
            },
            {
                "type": "text",
                "value": "EDRS",
                "name": "reception_station"
            },
            {
                "type": "double",
                "value": "2.0",
                "name": "channel"
            },
            {
                "type": "double",
                "value": "22.0",
                "name": "vcid"
            },
            {
                "type": "text",
                "value": "RT",
                "name": "playback_type"
            },
            {
                "name": "footprint_details",
                "type": "object",
                "values": [
                    {
                        "name": "footprint",
                        "type": "geometry",
                        "value": "POLYGON ((59.814781 41.210405, 59.705287 40.910757, 59.596632 40.611016, 59.488799 40.311186, 59.381774 40.011268, 59.275541 39.711262, 59.170086 39.41117, 59.065395 39.110994, 58.961453 38.810734, 58.858247 38.510393, 58.755763 38.20997, 58.653989 37.909469, 58.552911 37.608888, 58.452516 37.308231, 58.352794 37.007498, 58.25373 36.70669, 58.155315 36.405808, 58.057535 36.104853, 57.960381 35.803827, 57.86384 35.502731, 57.767902 35.201565, 57.672557 34.90033, 57.577794 34.599028, 57.483602 34.297659, 57.389973 33.996225, 57.296895 33.694727, 57.20436 33.393164, 57.112357 33.091539, 57.020879 32.789852, 56.929915 32.488105, 56.839457 32.186297, 56.749497 31.88443, 56.660025 31.582505, 56.571033 31.280522, 56.482514 30.978483, 56.394458 30.676387, 56.306859 30.374237, 56.219708 30.072033, 56.132997 29.769775, 56.04672 29.467465, 55.960869 29.165102, 55.875436 28.862689, 55.790415 28.560225, 55.705799 28.257712, 55.62158 27.95515, 55.537753 27.652539, 55.45431 27.349881, 55.371244 27.047177, 55.288549 26.744426, 55.206219 26.44163, 55.124249 26.138789, 55.042631 25.835905, 54.961361 25.532977, 54.880431 25.230006, 54.799838 24.926993, 54.719574 24.623939, 54.639634 24.320844, 54.560013 24.01771, 54.480705 23.714535, 54.401705 23.411322, 54.323008 23.10807, 54.244608 22.804781, 54.166501 22.501455, 54.08868 22.198093, 54.011143 21.894695, 53.933883 21.591262, 53.856896 21.287794, 53.780176 20.984291, 53.70372 20.680756, 53.627523 20.377188, 53.55158 20.073587, 53.475887 19.769955, 53.40044 19.466291, 53.325233 19.162597, 53.250263 18.858873, 53.175526 18.555119, 53.101017 18.251337, 53.026732 17.947526, 52.952668 17.643687, 52.87882 17.339821, 52.805183 17.035928, 52.731756 16.732008, 52.658532 16.428064, 52.585509 16.124093, 52.512683 15.820098, 52.440051 15.516079, 52.367607 15.212037, 52.29535 14.907971, 52.223275 14.603883, 52.151378 14.299772, 52.079656 13.99564, 52.008107 13.691487, 51.936725 13.387313, 51.865508 13.08312, 51.794453 12.778906, 51.723556 12.474674, 51.652813 12.170423, 51.582223 11.866153, 51.51178 11.561867, 51.441483 11.257563, 51.371327 10.953242, 51.301311 10.648905, 51.23143 10.344553, 51.161682 10.040185, 51.092063 9.735803000000001, 51.022571 9.431406000000001, 50.953203 9.126996, 50.883955 8.822571999999999, 50.814825 8.518136, 50.745809 8.213687, 50.676906 7.909226, 50.608111 7.604754, 50.539422 7.300271, 50.470837 6.995778, 50.402351 6.691274, 50.333964 6.386761, 50.265671 6.082239, 50.19747 5.777708, 50.129358 5.473169, 50.061333 5.168622, 49.993392 4.864068, 49.925531 4.559507, 49.85775 4.254939, 49.790043 3.950366, 49.72241 3.645788, 49.654847 3.341204, 49.587352 3.036616, 49.519922 2.732023, 49.452555 2.427427, 49.385247 2.122828, 49.317997 1.818226, 49.250801 1.513621, 49.183658 1.209015, 49.116564 0.904407, 49.049517 0.5997980000000001, 48.982514 0.295189, 48.915554 -0.009421000000000001, 48.848632 -0.31403, 48.781748 -0.618639, 48.714898 -0.923246, 48.648079 -1.227852, 48.58129 -1.532456, 48.514527 -1.837058, 48.447789 -2.141656, 48.381072 -2.446252, 48.314374 -2.750843, 48.247693 -3.055431, 48.181027 -3.360014, 48.114371 -3.664591, 48.047725 -3.969164, 47.981085 -4.27373, 47.91445 -4.57829, 47.847816 -4.882844, 47.781182 -5.18739, 47.714545 -5.491929, 47.647901 -5.79646, 47.581249 -6.100982, 47.514585 -6.405496, 47.447908 -6.71, 47.381215 -7.014495, 47.314503 -7.31898, 47.24777 -7.623454, 47.181012 -7.927917, 47.114228 -8.232369, 47.047415 -8.536809, 46.980571 -8.841237, 46.913691 -9.145652, 46.846775 -9.450055000000001, 46.77982 -9.754443999999999, 46.712822 -10.058819, 46.645779 -10.36318, 46.578688 -10.667527, 46.511547 -10.971858, 46.444353 -11.276174, 46.377103 -11.580474, 46.309795 -11.884758, 46.242425 -12.189025, 46.174992 -12.493275, 46.107491 -12.797508, 46.039921 -13.101722, 45.972279 -13.405919, 45.904561 -13.710096, 45.836765 -14.014255, 45.768887 -14.318394, 45.700926 -14.622513, 45.632878 -14.926611, 45.564739 -15.230689, 45.496508 -15.534746, 45.428181 -15.838781, 45.359755 -16.142794, 45.291226 -16.446785, 45.222593 -16.750752, 45.15385 -17.054697, 45.084997 -17.358618, 45.016029 -17.662515, 44.946942 -17.966388, 44.877735 -18.270236, 44.808403 -18.574058, 44.738943 -18.877855, 44.669352 -19.181626, 41.983236 -18.60262, 42.057859 -18.299327, 42.132258 -17.996, 42.206438 -17.692637, 42.280403 -17.38924, 42.354156 -17.085808, 42.427701 -16.782344, 42.501042 -16.478846, 42.574184 -16.175316, 42.647129 -15.871755, 42.719882 -15.568162, 42.792445 -15.264538, 42.864824 -14.960884, 42.937021 -14.657199, 43.00904 -14.353486, 43.080884 -14.049744, 43.152557 -13.745973, 43.224063 -13.442174, 43.295404 -13.138348, 43.366584 -12.834495, 43.437607 -12.530616, 43.508475 -12.226711, 43.579192 -11.92278, 43.649762 -11.618824, 43.720187 -11.314844, 43.79047 -11.01084, 43.860615 -10.706812, 43.930625 -10.402761, 44.000503 -10.098688, 44.070252 -9.794592, 44.139874 -9.490475, 44.209374 -9.186336000000001, 44.278754 -8.882177, 44.348016 -8.577997, 44.417164 -8.273797999999999, 44.486202 -7.969579, 44.55513 -7.665342, 44.623954 -7.361086, 44.692674 -7.056812, 44.761295 -6.75252, 44.829819 -6.448211, 44.898248 -6.143886, 44.966587 -5.839545, 45.034836 -5.535188, 45.102999 -5.230815, 45.17108 -4.926428, 45.239079 -4.622026, 45.307001 -4.317611, 45.374848 -4.013182, 45.442622 -3.70874, 45.510326 -3.404285, 45.577962 -3.099818, 45.645535 -2.795339, 45.713045 -2.49085, 45.780496 -2.186349, 45.84789 -1.881838, 45.91523 -1.577317, 45.982518 -1.272786, 46.049757 -0.968247, 46.11695 -0.663699, 46.184099 -0.359142, 46.251206 -0.054578, 46.318275 0.249993, 46.385308 0.554571, 46.452307 0.859156, 46.519275 1.163747, 46.586214 1.468343, 46.653127 1.772945, 46.720016 2.077551, 46.786885 2.382161, 46.853735 2.686775, 46.920569 2.991393, 46.987389 3.296014, 47.054199 3.600637, 47.121 3.905263, 47.187795 4.20989, 47.254587 4.514518, 47.321378 4.819147, 47.388171 5.123777, 47.454967 5.428407, 47.521771 5.733036, 47.588584 6.037664, 47.655409 6.342292, 47.722249 6.646917, 47.789105 6.95154, 47.855981 7.256161, 47.92288 7.560779, 47.989803 7.865393, 48.056753 8.170004, 48.123733 8.47461, 48.190746 8.779211999999999, 48.257794 9.083809, 48.324881 9.388400000000001, 48.392007 9.692985, 48.459177 9.997564000000001, 48.526393 10.302136, 48.593657 10.606701, 48.660972 10.911259, 48.728342 11.215808, 48.795768 11.520349, 48.863254 11.824881, 48.930801 12.129404, 48.998412 12.433917, 49.066092 12.73842, 49.133842 13.042913, 49.201665 13.347394, 49.269565 13.651864, 49.337545 13.956323, 49.405606 14.260769, 49.473753 14.565202, 49.541987 14.869623, 49.610313 15.17403, 49.678733 15.478423, 49.747251 15.782802, 49.815868 16.087166, 49.884589 16.391515, 49.953416 16.695848, 50.022353 17.000165, 50.091403 17.304466, 50.160569 17.60875, 50.229854 17.913017, 50.299262 18.217266, 50.368796 18.521497, 50.438459 18.82571, 50.508255 19.129903, 50.578186 19.434077, 50.648258 19.738231, 50.718472 20.042365, 50.788833 20.346479, 50.859345 20.650571, 50.93001 20.954641, 51.000833 21.25869, 51.071817 21.562716, 51.142967 21.86672, 51.214285 22.1707, 51.285776 22.474657, 51.357444 22.778589, 51.429292 23.082497, 51.501325 23.386379, 51.573548 23.690236, 51.645963 23.994068, 51.718575 24.297873, 51.791389 24.601651, 51.864408 24.905402, 51.937638 25.209125, 52.011082 25.51282, 52.084746 25.816487, 52.158633 26.120124, 52.232749 26.423732, 52.307097 26.72731, 52.381684 27.030857, 52.456514 27.334374, 52.531591 27.637859, 52.60692 27.941312, 52.682505 28.244733, 52.758353 28.548121, 52.834469 28.851476, 52.910859 29.154797, 52.987529 29.458084, 53.064483 29.761336, 53.141728 30.064553, 53.219269 30.367734, 53.297112 30.670879, 53.375263 30.973987, 53.453728 31.277058, 53.532514 31.580091, 53.611626 31.883085, 53.691071 32.186041, 53.770856 32.488957, 53.850987 32.791833, 53.931471 33.094669, 54.012314 33.397464, 54.093525 33.700217, 54.175109 34.002928, 54.257075 34.305597, 54.33943 34.608222, 54.422182 34.910803, 54.505337 35.213339, 54.588905 35.515831, 54.672892 35.818277, 54.757308 36.120677, 54.842161 36.423029, 54.92746 36.725334, 55.013212 37.027591, 55.099428 37.329799, 55.186116 37.631958, 55.273285 37.934067, 55.360946 38.236124, 55.449107 38.53813, 55.537779 38.840084, 55.626972 39.141985, 55.716696 39.443832, 55.806962 39.745625, 55.897782 40.047362, 55.989165 40.349044, 56.081123 40.650669, 56.173669 40.952236, 56.266813 41.253745, 56.360568 41.555195, 56.454947 41.856586, 59.814781 41.210405))"
                    }
                ]
            }
        ]

    def test_insert_rep_pass_only_hktm(self):

        filename = "S2A_OPER_REP_PASS_E_ONLY_HKTM.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_edrs_acquisition.ingestion_edrs_acquisition", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        # Check sources
        source = self.session.query(Source).filter(Source.validity_start == "2018-07-21T01:47:42.854151",
                                                   Source.validity_stop == "2018-07-21T01:47:43.833085",
                                                   Source.name == "S2A_OPER_REP_PASS_E_ONLY_HKTM.EOF",
                                                   Source.processor == "ingestion_edrs_acquisition.py").all()

        assert len(source) == 2

        # Check number of events generated
        events = self.session.query(Event).join(Source).filter(Source.name == "S2A_OPER_REP_PASS_E_ONLY_HKTM.EOF").all()

        assert len(events) == 1

    def test_insert_rep_pass_with_plan_playback_starting_before_than_MSI(self):

        filename = "S2A_NPPF_PLAYBACK_STARTING_BEFORE_THAN_MSI.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_nppf.ingestion_nppf", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2A_ORBPRE.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_orbpre.ingestion_orbpre", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2__SRA_2.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_slot_request_edrs.ingestion_slot_request_edrs", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]

        filename = "S2A_OPER_REP_PASS_E_NO_SAD.EOF"
        file_path = os.path.dirname(os.path.abspath(__file__)) + "/inputs/" + filename

        returned_value = ingestion.command_process_file("s2boa.ingestions.ingestion_edrs_acquisition.ingestion_edrs_acquisition", file_path, "2018-01-01T00:00:00")

        assert returned_value[0]["status"] == eboa_engine.exit_codes["OK"]["status"]
        assert returned_value[1]["status"] == eboa_engine.exit_codes["OK"]["status"]

        # Check sources
        source = self.session.query(Source).filter(Source.validity_start == "2018-07-21T05:22:08.947423",
                                                   Source.validity_stop == "2018-07-21T07:37:40.689924",
                                                   Source.name == "S2A_OPER_REP_PASS_E_NO_SAD.EOF",
                                                   Source.processor == "ingestion_edrs_acquisition.py").all()

        assert len(source) == 2

        source = self.session.query(Source).filter(Source.validity_start == "2018-07-21T05:22:08.947423",
                                                   Source.validity_stop == "2018-07-21T05:40:35.417601",
                                                   Source.name == "S2A_OPER_REP_PASS_E_NO_SAD.EOF",
                                                   Source.processor == "isp_planning_completeness_ingestion_edrs_acquisition.py").all()

        assert len(source) == 1
